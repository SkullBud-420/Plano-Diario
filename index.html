<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário de Cultivo Avançado</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Manifest PWA -->
    <!-- Bibliotecas para Exportação de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Biblioteca para arrastar e soltar (SortableJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34db95;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --vegetative: #27ae60;
            --preflower: #9b59b6;
            --flowering: #e74c3c;
            --fruiting: #f39c12;
            --transition: #3498db;
            --auto-color: #8e44ad;
            --photo-color: #e67e22;
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 12px 30px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #000000, #000000, #091506);
            color: #e0e0e0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.424);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
            border-bottom: 5px solid var(--vegetative);
        }

        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(
                90deg,
                var(--vegetative),
                var(--preflower),
                var(--flowering),
                var(--fruiting)
            );
        }

        h1 {
            color: #fff;
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: #b0b0b0;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 15px;
        }

        .plant-selector {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .selector-title {
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #plantCount {
            background: rgba(52, 152, 219, 0);
            color: #ffffff;
            padding: 3px 10px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 5px;
        }

        .carousel-container {
            position: relative;
            overflow: hidden;
            padding: 40px;
        }

        .plant-carousel {
            display: flex;
            transition: transform 0.5s ease-in-out;
            gap: 15px;
            padding: 10px 0;
            scroll-behavior: smooth;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .plant-carousel::-webkit-scrollbar {
            display: none;
        }

        .plant-card {
            background: rgba(12, 16, 14, 0);
            border-radius: 10px;
            padding: 15px;
            position: relative;
            border-left: 4px solid var(--vegetative);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            flex: 0 0 auto;
            width: 220px;
            scroll-snap-align: start;
        }

        .plant-card.photo {
            border-left-color: var(--photo-color);
        }

        .plant-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: rgb(0, 0, 0);
        }

        /* Estilos para arrastar e soltar (SortableJS) */
        .plant-card.sortable-ghost {
            opacity: 0.4;
            background: var(--secondary);
        }

        .plant-card.sortable-chosen {
            cursor: grabbing;
        }

        /* Novo: Estilo para o handle de arrastar */
        .plant-drag-handle {
            cursor: grab;
            color: #aaa;
            margin-right: 10px;
            touch-action: none; /* Impede o scroll ao tocar no handle */
        }

        .plant-card.selected {
            border: 4px solid var(--secondary);
            transform: translateY(-5px);
            background: rgba(36, 76, 4, 0.185);
        }

        .plant-name {
            font-size: 1.2rem;
            color: white;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .plant-details {
            font-size: 0.9rem;
            color: #b0b0b0;
            margin-bottom: 8px;
        }

        .plant-details i {
            margin-right: 6px;
            width: 14px;
            text-align: center;
        }

        .germination-date {
            font-size: 0.85rem;
            color: #8eccaf;
            margin-top: 5px;
        }

        .plant-age {
            background: rgba(52, 152, 219, 0.2);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
        }

        .plant-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .plant-phase {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            margin-top: 8px;
            font-weight: 600;
        }

        .phase-vegetative {
            background: rgba(39, 174, 96, 0.3);
            color: #7dcea0;
            border: 1px solid rgba(39, 174, 96, 0.5);
        }
        .phase-preflower {
            background: rgba(168, 99, 167, 0.3);
            color: #d7bde2;
            border: 1px solid rgba(155, 89, 182, 0.5);
        }
        .phase-flowering {
            background: rgba(163, 60, 231, 0.585);
            color: #f5b1ee;
            border: 1px solid rgba(231, 60, 163, 0.697);
        }
        .phase-fruiting {
            background: rgba(243, 18, 157, 0.768);
            color: #d9a0fa;
            border: 1px solid rgba(228, 18, 243, 0.5);
        }

        .type-auto {
            background: rgba(168, 84, 205, 0.45);
            color: #d6a2e8;
        }

        .type-photo {
            background: rgba(243, 126, 42, 0.644);
            color: #f8c471;
        }

        .carousel-nav {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            gap: 10px;
        }

        .nav-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-dot.active {
            background: var(--secondary);
            transform: scale(1.2);
        }

        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(30, 40, 35, 0);
            border: none;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 30%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .carousel-btn:hover {
            background: var(--secondary);
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        .carousel-btn i {
            font-size: 1.2rem;
        }

        .prev-btn {
            left: 0;
        }

        .next-btn {
            right: 0;
        }

        .add-plant-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--success);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            border-radius: 30%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .add-plant-btn:hover {
            transform: scale(1.1);
            background: #2ecc71;
        }

        .plant-card-btn {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-plant-btn {
            top: 10px;
            right: 10px;
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .edit-plant-btn {
            top: 50px;
            right: 10px;
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
        }

        .plant-card-btn:hover {
            transform: scale(1.1);
            background: rgb(0, 0, 0);
        }

        .timeline-section {
            background: rgb(8, 15, 10);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            margin-top: 20px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--secondary);
        }

        .timeline-title {
            font-size: 1.8rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .timeline-actions {
            display: flex;
            gap: 15px;
        }

        .action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .export-btn {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .add-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            margin: 20px auto;
            display: block;
        }

        .folder-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
        }

        .timeline-container {
            position: relative;
            padding: 0;
        }

        .timeline-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 100%;
            width: 5px;
            background: linear-gradient(
                to bottom,
                var(--vegetative),
                var(--preflower),
                var(--flowering),
                var(--fruiting)
            );
            border-radius: 3px;
            z-index: 0;
        }

        .timeline-event {
            position: relative;
            margin-bottom: 40px;
            width: 90%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 0;
        }

        .event-card {
            background: rgb(16, 20, 19);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            border-left: 4px solid var(--secondary);
            position: relative;
            width: 100%;
        }

        .event-card.current {
            border-left-color: var(--success);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.3);
        }

        .event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .event-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: white;
        }

        .vegetative-icon {
            background: var(--vegetative);
        }
        .preflower-icon {
            background: var(--preflower);
        }
        .flowering-icon {
            background: var(--flowering);
        }
        .fruiting-icon {
            background: var(--fruiting);
        }
        .action-icon {
            background: var(--secondary);
        }

        .event-date {
            font-weight: bold;
            color: var(--secondary);
            font-size: 1.2rem;
        }

        .event-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: white;
            margin-bottom: 10px;
        }

        .event-phase {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .phase-vegetative {
            background: rgba(39, 174, 96, 0.3);
            color: #7dcea0;
        }
        .phase-preflower {
            background: rgba(155, 89, 182, 0.3);
            color: #d7bde2;
        }
        .phase-flowering {
            background: rgba(231, 60, 165, 0.3);
            color: #f5b7b1;
        }
        .phase-fruiting {
            background: rgba(168, 18, 243, 0.312);
            color: #fad7a0;
        }

        .event-description {
            color: #b0b0b0;
            line-height: 1.7;
            margin-bottom: 20px;
            font-size: 1.05rem;
        }

        .event-details {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 18px;
            border-left: 4px solid var(--secondary);
        }

        /* Novo: Estilo para info de setup dentro de um evento */
        .event-setup-info {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #c0c0c0;
            border-left: 3px solid rgba(255, 255, 255, 0.1);
        }

        .event-setup-info div {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .event-setup-info i.fa-lightbulb { color: #f1c40f; }
        .event-setup-info i.fa-home { color: #3498db; }
        .event-setup-info i.fa-clock { color: #95a5a6; } /* Cor para o ícone de duração */
        .event-setup-info i.fa-hourglass-half { color: #e67e22; } /* Laranja para tempo de luz */

        .detail-item {
            flex: 1 1 120px;
            background: rgba(30, 40, 35, 0.5);
            padding: 10px 12px;
            border-radius: 8px;
            border-left: 3px solid var(--secondary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 100px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #aaa;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .event-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .event-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease;
            background: #1a2a1f;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: block;
        }

        .event-image:hover {
            transform: scale(1.05);
            border-color: var(--secondary);
        }

        .actions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }

        .action-chip {
            background: rgba(52, 152, 219, 0.3);
            border-radius: 20px;
            padding: 6px 14px;
            font-size: 0.9rem;
            color: #3498db;
            display: inline-flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .action-chip:hover {
            background: rgba(52, 152, 219, 0.4);
            transform: translateY(-2px);
        }

        .action-chip i {
            margin-right: 6px;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(30, 40, 35, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .action-button:hover {
            transform: translateY(-3px);
            border-color: var(--secondary);
            background: rgba(40, 50, 45, 0.9);
        }

        .action-button.selected {
            background: rgba(52, 152, 219, 0.3);
            border-color: var(--secondary);
            transform: scale(1.05);
        }

        .action-button i {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }

        .action-button .action-label {
            font-size: 0.85rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #b0b0b0;
        }

        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 95%;
            max-height: 95%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .image-modal-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8);
        }

        .image-close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ffffff;
            color: rgb(0, 0, 0);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .event-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .event-modal-content {
            background: rgba(20, 30, 25, 0.95);
            width: 90%;
            max-width: 600px;
            border-radius: 15px;
            padding: 25px;
            position: relative;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.6);
            max-height: 90vh;
            overflow-y: auto;
        }

        .event-modal-content h2 {
            color: white;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #b0b0b0;
            font-weight: 500;
        }

        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(30, 40, 35, 0.7);
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus, 
        .form-group select:focus, 
        .form-group textarea:focus {
            outline: none;
            border-color: var(--secondary);
        }

        .image-upload {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .image-preview {
            margin-top: 10px;
        }

        .image-preview img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.cancel {
            background: rgba(120, 120, 120, 0.3);
            color: white;
        }

        .modal-btn.save {
            background: var(--success);
            color: white;
        }

        .modal-btn.delete {
            background: rgba(231, 76, 60, 0.3);
            color: #e74c3c;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #b0b0b0;
            margin-top: 30px;
            font-size: 0.9rem;
        }

        .status-bar {
            padding: 8px;
            background: rgba(40, 40, 50, 0.8);
            border-radius: 6px;
            margin-bottom: 12px;
            text-align: center;
            display: none;
        }

        .status-bar.success {
            background: rgba(39, 174, 96, 0.3);
            border-left: 4px solid #27ae60;
        }

        .status-bar.error {
            background: rgba(231, 76, 60, 0.3);
            border-left: 4px solid #e74c3c;
        }

        .folder-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(52, 152, 219, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-indicator i {
            color: #3498db;
        }

        .event-actions {
            position: absolute;
            top: 12px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .event-action-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
        }

        .event-action-btn:hover {
            transform: scale(1.1);
            background: var(--secondary);
            color: #fff;
        }

        .edit-event-btn {
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
        }

        .delete-event-btn {
            background: rgba(231, 76, 60, 0.15);
            color: #e74c3c;
        }

        .event-action-btn:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* Validação de formulários */
        .input-error {
            border: 1px solid var(--danger) !important;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        /* Permissão de arquivos */
        .permission-request {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .permission-content {
            background: rgba(20, 30, 25, 0.95);
            width: 90%;
            max-width: 500px;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
        }
        
        .permission-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            header {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .plant-list {
                grid-template-columns: 1fr;
            }
            
            .timeline-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .timeline-actions {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .timeline-container {
                padding: 0;
            }
            
            .timeline-container::before {
                left: 50%;
            }
            
            .timeline-event {
                padding-left: 0;
                width: 95%;
            }
            
            .timeline-event::before {
                left: calc(50% - 10 px);
            }
            
            .event-details {
                grid-template-columns: 1fr;
            }

            .carousel-container {
                padding: 0 30px;
            }

            .carousel-btn {
                width: 35px;
                height: 35px;
            }

            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            }
        }
    
        .plano-rega-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: var(--secondary);
            color: white;
            padding: 10px 18px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            transition: all 0.3s ease;
        }

        .plano-rega-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        @media (max-width: 600px) {
            .plano-rega-btn {
                top: 10px;
                left: 10px;
                padding: 8px 14px;
                font-size: 0.85rem;
            }
        }
        .card-action-menu {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(20, 30, 25, 0.95);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            padding: 10px;
            display: none;
            flex-direction: column;
            gap: 8px;
            z-index: 20;
        }

        .card-action-menu button {
            background: none;
            border: none;
            color: white;
            font-weight: 500;
            padding: 5px 10px;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .card-action-menu button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Estilos para o calendário de rega */
        .watering-calendar {
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-title {
            font-size: 1.2rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav-btn {
            background: rgba(30, 40, 35, 0.8);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--secondary);
        }

        .calendar-days-container {
            overflow-x: auto;
            scrollbar-width: none;
            padding: 10px 0;
        }

        .calendar-days-container::-webkit-scrollbar {
            display: none;
        }

        .calendar-days {
            display: flex;
            gap: 10px;
            min-width: max-content;
        }

        .day-card {
            background: rgba(12, 16, 14, 0.493);
            border-radius: 10px;
            padding: 15px;
            min-width: 120px;
            position: relative;
            transition: all 0.3s ease;
            border-left: 4px solid var(--vegetative);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .day-card.today {
            border-left-color: var(--secondary);
            transform: scale(1.05);
            background: rgba(40, 50, 45, 0.439);
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .day-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .day-phase {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .watering-info {
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .watering-status {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 5px;
        }

        .watering-status i {
            font-size: 0.9rem;
        }

        .watering-yes {
            color: var(--success);
        }

        .watering-no {
            color: #95a5a6; /* Alterado de var(--danger) para cinza */
        }

        .watering-values {
            margin-top: 8px;
            font-size: 0.85rem;
        }

        /* Novas cores para tipos de rega */
        .watered-type-agua { color: #3498db !important; } /* Azul para água */
        .watered-type-fertilizante-mineral { color: #f1c40f !important; } /* Amarelo para mineral */
        .watered-type-fertilizante-organo-mineral { color: #e67e22 !important; } /* Laranja para organo-mineral */
        .watered-type-fertilizante-organico { color: #2ecc71 !important; } /* Verde claro para orgânico */
        .watered-type-flush { color: #9b59b6 !important; } /* Roxo para flush */

        .watering-values div {
            display: flex;
            justify-content: space-between;
        }

        .watering-label {
            color: #b0b0b0;
        }

        .watering-value {
            font-weight: bold;
        }

        .current-day-indicator {
            position: absolute;
            top: -4px;
            left: 80%;
            transform: translateX(-50%);
            width: auto;
            height: auto;
            padding: 2px 10px;
            border-radius: 20px;
            background: var(--secondary);
            color: rgb(255, 255, 255);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.445);
        }

        @media (max-width: 768px) {
            .day-card {
                min-width: 100px;
                padding: 10px;
            }
        }
            .calendar-week-indicator {
            background: rgba(52, 152, 219, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            font-weight: bold;
        }

        .plant-age-container {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        .plant-weeks {
            background: rgba(155, 89, 182, 0.2);
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        /* 3. Linha central só aparece quando planta é selecionada */
.timeline-container::before {
    display: none; /* Esconder por padrão */
}

.timeline-container.has-plant::before {
    display: block; /* Mostrar apenas quando tem planta */
}

/* 2. Ajustar estilo do indicador de semana */
.calendar-week-indicator {
    background: rgba(52, 152, 219, 0.2);
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    margin-left: 10px;
    font-weight: bold;
}
 /* Novo estilo para botão de configuração */
        .config-btn {
            position: absolute;
            top: 30px; /* Movido para o canto superior esquerdo */
            left: 20px;
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
            border: none;
            width:25px;
            height: 25px;
            border-radius: 30%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .config-btn:hover {
            background: #3498db;
            color: white;
            transform: scale(1.1);
        }
        
        /* Estilo para NPK no calendário */
        .watering-npk {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: bold;
            color: #f1c40f;
            background: rgba(0, 0, 0, 0.3);
            padding: 4px 8px;
            border-radius: 5px;
            text-align: center;
        }
        /* Botão de menu de contexto */
        .plant-menu-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 10;
        }

        .plant-menu-btn:hover {
            color: white;
        }

        .plant-menu {
            position: absolute;
            top: 35px;
            right: 10px;
            background: rgba(30, 40, 35, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        .plant-menu button {
            padding: 8px 15px;
            background: none;
            border: none;
            color: #ddd;
            text-align: left;
            cursor: pointer;
            white-space: nowrap;
        }

        .plant-menu button:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        /* Estilo para o menu de contexto na timeline */
        .event-actions {
            position: absolute;
            top: 12px;
            right: 15px;
        }

        .event-menu-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .event-menu-btn:hover {
            background: var(--secondary);
        }

        .event-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: rgba(30, 40, 35, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        .event-menu button {
            padding: 8px 15px;
            background: none;
            border: none;
            color: #ddd;
            text-align: left;
            cursor: pointer;
            white-space: nowrap;
        }

        .event-menu button:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        
        /* Estilo para o menu de NPK no calendário */
        .calendar-menu {
            position: absolute;
            top: 40px;
            right: 0;
            background: rgba(30, 40, 35, 0.95);
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 100;
        }
        /* Adicionar este novo estilo para o botão de rega rápida */
        .day-water-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(52, 152, 219, 0.3);
            color: #3498db;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .day-water-btn:hover {
            background: #3498db;
            color: white;
            transform: scale(1.1);
        }
        
        .day-water-btn.watered {
            background: var(--success);
            color: white;
        }
        
        .day-water-btn.watered i {
            color: white;
        }
        
        .watered-icon {
            color: var(--success);
            animation: pulse 0.5s;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        /* Garantir que os cards de dia tenham posição relativa */
        .day-card {
            position: relative;
        }

        /* Novos estilos para o container de setup */
        .setup-container {
            display: flex;
            align-items: center;
            margin-top: 4px;
        }

        .setup-info div {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        /* Estilos para a lista de setups no modal */
        .setup-list-item {
            background: rgba(30, 40, 35, 0.7);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--warning);
        }

        .setup-item-details h4 {
            margin: 0 0 5px 0;
            color: white;
        }

        .setup-item-details p {
            margin: 0;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        .setup-item-actions button {
            background: none;
            border: none;
            color: #b0b0b0;
            cursor: pointer;
            font-size: 1.1rem;
            margin-left: 10px;
            transition: color 0.2s ease;
        }

        .setup-item-actions button:hover {
            color: white;
        }

        /* Estilos para o Modal de Configuração com Abas */
        .config-tabs {
            display: flex;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .config-tab {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .config-tab:hover {
            color: white;
        }

        .config-tab.active {
            color: var(--secondary);
            border-bottom-color: var(--secondary);
        }

        .config-tab-content {
            display: none;
        }

        .config-tab-content.active {
            display: block;
        }

        /* Estilos para o Modal de Informações da Planta */
        #plantInfoContent {
            color: #e0e0e0;
        }

        .info-section {
            background: rgb(0, 0, 0);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--secondary);
        }

        .info-section h3 {
            color: var(--secondary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .info-item {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .info-item .label {
            font-size: 0.9rem;
            color: #b0b0b0;
            display: block;
            margin-bottom: 4px;
        }

        .info-item .value {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
        }

        .info-list ul { list-style: none; padding: 0; }
        .info-list li { padding: 8px 0; border-bottom: 1px solid rgb(0, 0, 0); display: flex; justify-content: space-between; align-items: center; }
        .info-list li:last-child { border-bottom: none; }
        .info-list li strong { 
            font-size: 1.1rem;
            color: var(--secondary);
        }
        /* Modal de seleção de rega */
        .watering-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .watering-modal-content {
            background: rgba(20, 30, 25, 0.95);
            width: 90%;
            max-width: 400px;
            border-radius: 15px;
            padding: 25px;
            position: relative;
        }

        .watering-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        .watering-option {
            padding: 12px;
            background: rgba(30, 40, 35, 0.7);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .watering-option:hover {
            background: rgba(52, 152, 219, 0.3);
            border-color: var(--secondary);
        }

        .watering-option i {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        /* Galeria de Fotos */
        .photo-gallery {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .photo-gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .photo-gallery-title {
            font-size: 1.2rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .photo-grid {
            display: flex;
            overflow-x: auto;
            gap: 15px;
            padding: 10px 0;
            scrollbar-width: none; /* Oculta a barra de rolagem no Firefox */
        }

        .photo-grid::-webkit-scrollbar {
            display: none; /* Oculta a barra de rolagem no Chrome, Safari, etc. */
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 80px; /* Largura fixa para o carrossel */
            height: 80px;
            flex-shrink: 0; /* Impede que os itens encolham */
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .photo-item:hover img {
            transform: scale(1.05);
        }

        /* Modal de Galeria Ampliada */
        .gallery-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .gallery-modal-content {
            position: relative;
            width: 90%;
            max-width: 800px;
            height: 90%;
            display: flex;
            flex-direction: column;
        }

        .gallery-main-image {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-main-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 10px;
        }

        .gallery-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .gallery-nav-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-nav-btn:hover {
            background: var(--secondary);
        }

        .gallery-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            color: black;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-thumbnails {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding: 10px 0;
        }

        .gallery-thumbnail {
            width: 80px;  /* Ajuste a largura aqui */
            height: 80px; /* Ajuste a altura aqui */
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .gallery-thumbnail.active {
            opacity: 1;
            border: 2px solid var(--secondary);
        }

        .gallery-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    
   <div class="container">
        <header>
            <button class="config-btn" id="configBtn">
                <i class="fas fa-flask"></i>
            </button>
            <h1><i class="fas fa-skull"></i> Skull Bud 420</h1>
            <p class="subtitle">Plano Diário</p>
        </header>

        <div class="environments-summary" id="environmentsSummary">
            <!-- Conteúdo gerado por JS -->
        </div>



        <div class="plant-selector">
            <div class="selector-title">
                <i class="fas fa-seedling"></i> Suas Plantas <span id="plantCount"></span>
            </div>
            <button class="add-plant-btn" id="addPlantBtn">
                <i class="fas fa-plus"></i>
            </button>
            <div class="carousel-container">
                <button class="carousel-btn prev-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="plantList" class="plant-carousel">
                    <!-- Plantas serão carregadas aqui -->
                </div>
                <button class="carousel-btn next-btn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <div class="carousel-nav">
                <!-- Pontos de navegação serão adicionados aqui -->
            </div>
        </div>

        <!-- Calendário de Rega (com menu de contexto) -->
    <div class="watering-calendar" id="wateringCalendar" style="display: none;">
        <div class="calendar-header">
            <h3 class="calendar-title">
                <i class="fas fa-calendar-alt"></i> Calendário de Rega
                <span class="calendar-week-indicator" id="weekIndicator">S1</span>
            </h3>
            <div class="calendar-nav">
                <button class="calendar-menu-btn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="calendar-menu">
                    <button id="configureNPKBtn">Configurar NPK</button>
                </div>
                <button class="calendar-nav-btn" id="prevWeekBtn">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="calendar-nav-btn" id="nextWeekBtn">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="calendar-days-container">
            <div class="calendar-days" id="calendarDays">
                    <!-- Dias serão carregados aqui -->
                </div>
            </div>
        </div>

        <div class="timeline-section">
            <div class="timeline-header">
                <h2 class="timeline-title" id="timelineTitle">
                    <i class="fas fa-chart-line"></i> <span id="plantNameTitle"></span>
                </h2>
                <div class="timeline-actions">
                    <button class="action-btn folder-btn" id="selectFolderBtn" style="display: none;">
                        <i class="fas fa-folder-open"></i> Selecionar Pasta
                    </button>
                    <button class="action-btn export-btn" id="exportTimelineBtn">
                        <i class="fas fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
            </div>
            <button class="action-btn add-btn" id="addEventBtn">
                <i class="fas fa-plus"></i> Adicionar Novo Evento
            </button>

            <!-- Galeria de Fotos -->
            <div class="photo-gallery" id="photoGallery">
                <div class="photo-gallery-header">
                    <h3 class="photo-gallery-title">
                        <i class="fas fa-images"></i> Fotos
                    </h3>
                </div>
                <div class="photo-grid" id="photoGrid">
                    <!-- Fotos serão carregadas aqui -->
                </div>
            </div>

            <div class="timeline-container" id="timelineContainer">
                <div class="empty-state">
                    <i class="fas fa-seedling"></i>
                    <p>Selecione uma planta para visualizar sua linha do tempo</p>
                    <p>Os eventos de cultivo serão exibidos aqui</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para exibir imagens em tela cheia -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-close-modal" onclick="closeImageModal()">×</button>
            <img id="modalImage" src="" />
        </div>
    </div>

    <!-- Modal de Galeria Ampliada -->
    <div id="galleryModal" class="gallery-modal">
        <div class="gallery-modal-content">
            <button class="gallery-close" onclick="closeGalleryModal()">×</button>
            <div class="gallery-main-image">
                <img id="galleryMainImage" src="" alt="Imagem ampliada">
            </div>
            <div class="gallery-nav">
                <button class="gallery-nav-btn" id="prevPhotoBtn"><i class="fas fa-chevron-left"></i> Anterior</button>
                <span id="galleryPhotoInfo"></span>
                <button class="gallery-nav-btn" id="nextPhotoBtn">Próxima <i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="gallery-thumbnails" id="galleryThumbnails">
                <!-- Miniaturas serão adicionadas aqui -->
            </div>
        </div>
    </div>

    <!-- Modal para registro de eventos -->
    <div id="eventModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-calendar-plus"></i> <span id="eventModalTitle">Adicionar Registro</span></h2>
            <form id="eventForm">
                <input type="hidden" id="eventId">
                <div class="form-group">
                    <label for="eventDate">Data</label>
                    <input type="date" id="eventDate" required>
                    <div id="dateError" class="error-message" style="display: none;"></div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ph">pH</label>
                        <input type="number" id="ph" step="0.1" min="0" max="14" placeholder="Ex: 6.0">
                    </div>
                    <div class="form-group">
                        <label for="ec">EC (mS/cm)</label>
                        <input type="number" id="ec" step="0.1" min="0" placeholder="Ex: 1.2">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature">Temperatura (°C)</label>
                        <input type="number" id="temperature" step="0.1" placeholder="Ex: 24.5">
                    </div>
                    <div class="form-group">
                        <label for="humidity">Umidade (%)</label>
                        <input type="number" id="humidity" min="0" max="100" placeholder="Ex: 65">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="wateringType">Tipo de Rega</label>
                    <select id="wateringType">
                        <option value="">Selecione...</option>
                        <option value="Água">Água</option>
                        <option value="Fertilizante Mineral">Fertilizante Mineral</option>
                        <option value="Fertilizante Organo-Mineral">Fertilizante Organo-Mineral</option>
                        <option value="Fertilizante Orgânico">Fertilizante Orgânico</option>
                        <option value="Flush">Flush</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ações Realizadas</label>
                    <div class="action-buttons" id="actionButtons">
                        <div class="action-button" data-action="Poda FIM">
                            <i class="fas fa-cut"></i>
                            <div class="action-label">Poda FIM</div>
                        </div>
                        <div class="action-button" data-action="Poda Top">
                            <i class="fas fa-cut"></i>
                            <div class="action-label">Poda Top</div>
                        </div>
                         <div class="action-button" data-action="Defoliação">
                            <i class="fas fa-leaf"></i>
                            <div class="action-label">Defoliação</div>
                        </div>
                          <div class="action-button" data-action="Transplante">
                            <i class="fas fa-seedling"></i>
                            <div class="action-label">Transplante</div>
                        </div>
                        <div class="action-button" data-action="LST">
                            <i class="fas fa-vine"></i>
                            <div class="action-label">LST</div>
                        </div>
                        <div class="action-button" data-action="SCROG">
                            <i class="fas fa-border-all"></i>
                            <div class="action-label">SCROG</div>
                        </div>
                        <div class="action-button" data-action="Controle de Praga">
                            <i class="fas fa-bug"></i>
                            <div class="action-label">Controle de Praga</div>
                        </div>
                        <div class="action-button" data-action="Colheita">
                            <i class="fas fa-cannabis"></i>
                            <div class="action-label">Colheita</div>
                        </div>
                    </div>
                </div>
                
                <div id="harvestFields" class="form-group" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="wetWeight">Peso Úmido (g)</label>
                            <input type="number" id="wetWeight" step="0.1" min="0" placeholder="Ex: 150.5">
                        </div>
                        <div class="form-group">
                            <label for="dryWeight">Peso Seco (g)</label>
                            <input type="number" id="dryWeight" step="0.1" min="0" placeholder="Ex: 35.2">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="notes">Observações</label>
                    <textarea id="notes" rows="3" placeholder="Descreva o desenvolvimento da planta..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Imagens</label>
                    <div class="image-upload">
                        <input type="file" id="eventImage" accept="image/*" capture="camera">
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-btn delete" id="deleteEventBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button type="button" class="modal-btn cancel" onclick="closeEventModal()">Cancelar</button>
                    <button type="submit" class="modal-btn save">Salvar Registro</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para adicionar/editar planta -->
    <div id="plantModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-seedling"></i> <span id="plantModalTitle">Nova Planta</span></h2>
            <form id="plantForm">
                <input type="hidden" id="plantId">
                <div class="form-group">
                    <label for="plantName">Nome da Planta</label>
                    <input type="text" id="plantName" placeholder="Ex: Gorilla Glue" required>
                </div>
                <div class="form-group">
                    <label for="plantGenetics">Genética / Strain</label>
                    <input type="text" id="plantGenetics" placeholder="Ex: Sativa Dominante, Híbrida, etc.">
                </div>
                <div class="form-group">
                    <label for="germinationDate">Data da Germinação</label>
                    <input type="date" id="germinationDate" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="plantSetup">Setup (Ambiente/Iluminação)</label>
                        <select id="plantSetup" required></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Planta</label>
                    <div style="display: flex; gap: 10px;">
                        <label style="flex: 1; background: #512da8; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; color: white;">
                            <input type="radio" name="plantType" value="auto" checked style="margin-right: 5px;">
                            Automática
                        </label>
                        <label style="flex: 1; background: #0277bd; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; color: white;">
                            <input type="radio" name="plantType" value="photo" style="margin-right: 5px;">
                            Fotoperíodo
                        </label>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn delete" id="deletePlantBtn" style="display: none;">
                        <i class="fas fa-trash"></i> Excluir
                    </button>
                    <button type="button" class="modal-btn cancel" onclick="closePlantModal()">Cancelar</button>
                    <button type="submit" class="modal-btn save">Salvar Planta</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Mudança de Fase -->
    <div id="phaseChangeModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-sync-alt"></i> Mudar Fase da Planta</h2>
            <form id="phaseChangeForm">
                <input type="hidden" id="phaseChangePlantId">
                <div class="form-group">
                    <label>Fase Atual</label>
                    <p id="currentPhaseText" style="font-size: 1.1rem; font-weight: bold;"></p>
                </div>
                <div class="form-group">
                    <label for="newPhaseSelect">Selecione a Nova Fase</label>
                    <select id="newPhaseSelect" required>
                        <option value="vegetative">Vegetativo</option>
                        <option value="preflower">Pré-floração</option>
                        <option value="flowering">Floração</option>
                        <option value="fruiting">Frutificação</option>
                        <option value="harvest">Colheita</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="phaseChangeDate">Data da Mudança</label>
                    <input type="date" id="phaseChangeDate" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn cancel" onclick="closePhaseChangeModal()">Cancelar</button>
                    <button type="submit" class="modal-btn save">Salvar Mudança</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal para mudança de setup -->
    <div id="setupChangeModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-cogs"></i> Mudar Setup da Planta</h2>
            <form id="setupChangeForm">
                <input type="hidden" id="setupChangePlantId">
                 <div class="form-group">
                    <label for="newPlantSetupSelect">Selecione o Novo Setup</label>
                    <select id="newPlantSetupSelect" required></select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn cancel" onclick="closeSetupChangeModal()">Cancelar</button>
                    <button type="submit" class="modal-btn save">Salvar Mudança</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para permissão de sistema de arquivos -->
    <div id="permissionRequest" class="permission-request" style="display: none;">
        <div class="permission-content">
            <h2><i class="fas fa-folder-open"></i> Permissão de Acesso ao Sistema de Arquivos</h2>
            <p>Para salvar e carregar imagens de forma eficiente, precisamos de acesso a um diretório no seu dispositivo.</p>
            <p>Por favor, selecione um diretório para salvar os arquivos de imagem do diário.</p>
            <div class="permission-buttons">
                <button id="grantPermissionBtn" class="modal-btn save">Conceder Permissão</button>
                <button id="denyPermissionBtn" class="modal-btn cancel">Recusar</button>
            </div>
        </div>
    </div>

    <!-- Modal para seleção de tipo de rega -->
    <div id="wateringModal" class="watering-modal">
        <div class="watering-modal-content">
            <h2><i class="fas fa-tint"></i> Selecionar Tipo de Rega</h2>
            <p id="wateringDateText">Para o dia: </p>
            <div class="watering-options">
                <div class="watering-option" data-type="Água">
                    <i class="fas fa-tint"></i>
                    <div>Água</div>
                </div>
                <div class="watering-option" data-type="Fertilizante Mineral">
                    <i class="fas fa-flask"></i>
                    <div>Fertilizante Mineral</div>
                </div>
                <div class="watering-option" data-type="Fertilizante Organo-Mineral">
                    <i class="fas fa-leaf"></i>
                    <div>Fertilizante Organo-Mineral</div>
                </div>
                <div class="watering-option" data-type="Fertilizante Orgânico">
                    <i class="fas fa-seedling"></i>
                    <div>Fertilizante Orgânico</div>
                </div>
                <div class="watering-option" data-type="Flush">
                    <i class="fas fa-recycle"></i>
                    <div>Flush</div>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button type="button" class="modal-btn cancel" onclick="closeWateringModal()">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- Modal para Pré-visualização de PDF -->
    <div id="pdfPreviewModal" class="event-modal">
        <div class="event-modal-content" style="max-width: 90%; width: 800px; height: 95vh; display: flex; flex-direction: column;">
            <h2 style="flex-shrink: 0;"><i class="fas fa-file-pdf"></i> Pré-visualização do PDF</h2>
            <div id="pdfPreviewContainer" style="flex-grow: 1; background: #555; border-radius: 8px; overflow: hidden;">
                <iframe id="pdfPreviewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            <div class="modal-buttons" style="flex-shrink: 0;">
                <button type="button" class="modal-btn cancel" onclick="closePdfPreviewModal()">Fechar</button>
                <button type="button" class="modal-btn save" id="downloadPdfBtn">Baixar PDF</button>
            </div>
        </div>
    </div>

    <!-- Modal para Opções de PDF -->
    <div id="pdfOptionsModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-cog"></i> Opções de Exportação de PDF</h2>
            <form id="pdfOptionsForm">
                <div class="form-group">
                    <label for="pdfTitle">Título do Documento</label>
                    <input type="text" id="pdfTitle" placeholder="Diário de Cultivo: Nome da Planta">
                </div>
                <div class="form-group" style="display: flex; flex-direction: column; gap: 10px;">
                    <label>
                        <input type="checkbox" id="pdfIncludeDetails" checked> Incluir tabela de detalhes (pH, EC, etc.)
                    </label>
                    <label>
                        <input type="checkbox" id="pdfIncludeImages" checked> Incluir imagens dos eventos
                    </label>
                    <label>
                        <input type="checkbox" id="pdfIncludeSetup" checked> Incluir informações de Setup (Iluminação/Ambiente)
                    </label>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="modal-btn cancel" onclick="closePdfOptionsModal()">Cancelar</button>
                    <button type="submit" class="modal-btn save">Gerar PDF</button>
                </div>
            </form>
        </div>
    </div>
    <footer>
        <p>Plano de Rega Avançado | Desenvolvido para Fertilizantes NPK</p>
        <p>Cultive com sabedoria, colha com satisfação</p>
        <p style="margin-top: 8px; font-weight: bold">
            <a href="https://www.instagram.com/skullbud420" style="color: #3498db; text-decoration: none" target="_blank">
                @SKULL BUD 420
            </a>
        </p>
    </footer>

    <!-- Modal de Informações da Planta -->
    <div id="plantInfoModal" class="event-modal">
        <div class="event-modal-content">
            <h2><i class="fas fa-info-circle"></i> Informações da Planta</h2>
            <div id="plantInfoContent">
                <!-- Conteúdo será gerado por JS -->
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn cancel" onclick="closePlantInfoModal()">Fechar</button>
            </div>
        </div>
    </div>
<div id="statusBar" class="status-bar success" style="display: none"></div>
   <!-- Modal Unificado de Configurações -->
    <div id="configModal" class="event-modal">
        <div class="event-modal-content">
            <div class="config-tabs">
                <button class="config-tab active" data-tab="setups"><i class="fas fa-cogs"></i> Setups</button>
                <button class="config-tab" data-tab="fertilizers"><i class="fas fa-flask"></i> Fertilizantes</button>
            </div>

            <!-- Conteúdo da Aba de Setups -->
            <div id="setupsTabContent" class="config-tab-content active">
                <h2><i class="fas fa-cogs"></i> Gerenciar Setups</h2>
                <p style="color: #b0b0b0; font-size: 0.9rem; margin-bottom: 20px;">
                    Crie e edite seus setups de cultivo (iluminação e ambiente) aqui.
                </p>
                <form id="setupForm" class="form-group">
                    <input type="hidden" id="setupId">
                    <div class="form-group">
                        <label for="setupName">Nome do Setup</label>
                        <input type="text" id="setupName" placeholder="Ex: Vega LED 150W" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="setupLighting">Iluminação</label>
                            <input type="text" id="setupLighting" placeholder="Ex: LED 150W" required>
                        </div>
                        <div class="form-group">
                            <label for="setupEnvironment">Ambiente</label>
                            <input type="text" id="setupEnvironment" placeholder="Ex: Grow 80x80" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="setupLightDuration">Tempo de Luz (horas/dia)</label>
                        <input type="text" id="setupLightDuration" placeholder="Ex: 18/6, 12/12, 24/0">
                    </div>
                    <button type="submit" class="modal-btn save" style="width: 100%;">Salvar Setup</button>
                </form>
                <div id="setupsList" style="margin-top: 20px;"></div>
            </div>

            <!-- Conteúdo da Aba de Fertilizantes -->
            <div id="fertilizersTabContent" class="config-tab-content">
                <h2><i class="fas fa-flask"></i> Configuração de Fertilizantes</h2>
                <form id="npkForm">
                    <!-- ... (conteúdo do formulário NPK permanece o mesmo) ... -->
                    <div class="form-group">
                        <h3>Fase Vegetativa</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vegN">Nitrogênio (N)</label>
                                <input type="number" id="vegN" min="0" step="0.1" placeholder="Ex: 10">
                            </div>
                            <div class="form-group">
                                <label for="vegP">Fósforo (P)</label>
                                <input type="number" id="vegP" min="0" step="0.1" placeholder="Ex: 5">
                            </div>
                            <div class="form-group">
                                <label for="vegK">Potássio (K)</label>
                                <input type="number" id="vegK" min="0" step="0.1" placeholder="Ex: 5">
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <h3>Fase de Floração</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="flowerN">Nitrogênio (N)</label>
                                <input type="number" id="flowerN" min="0" step="0.1" placeholder="Ex: 5">
                            </div>
                            <div class="form-group">
                                <label for="flowerP">Fósforo (P)</label>
                                <input type="number" id="flowerP" min="0" step="0.1" placeholder="Ex: 10">
                            </div>
                            <div class="form-group">
                                <label for="flowerK">Potássio (K)</label>
                                <input type="number" id="flowerK" min="0" step="0.1" placeholder="Ex: 15">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <h3>Fase de Frutificação</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fruitN">Nitrogênio (N)</label>
                                <input type="number" id="fruitN" min="0" step="0.1" placeholder="Ex: 3">
                            </div>
                            <div class="form-group">
                                <label for="fruitP">Fósforo (P)</label>
                                <input type="number" id="fruitP" min="0" step="0.1" placeholder="Ex: 12">
                            </div>
                            <div class="form-group">
                                <label for="fruitK">Potássio (K)</label>
                                <input type="number" id="fruitK" min="0" step="0.1" placeholder="Ex: 18">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-buttons" style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; margin-top: 15px;">
                <button type="button" class="modal-btn cancel" onclick="closeConfigModal()">Fechar</button>
                <button type="submit" form="npkForm" class="modal-btn save" id="saveFertilizerBtn">Salvar Fertilizantes</button>
            </div>
        </div>
    </div>
    <script>
         // Configuração do IndexedDB
        const openDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('PlantDiaryDB', 3); // Versão aumentada para 3
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    
                    // Criar object stores se necessário
                    if (oldVersion < 1 || !db.objectStoreNames.contains('plants')) {
                        db.createObjectStore('plants', { keyPath: 'id' });
                    }
                    
                    if (oldVersion < 1 || !db.objectStoreNames.contains('journalEntries')) {
                        db.createObjectStore('journalEntries', { keyPath: 'id' });
                    }
                    
                    if (oldVersion < 1 || !db.objectStoreNames.contains('npkSettings')) {
                        db.createObjectStore('npkSettings');
                    }
                    
                    if (oldVersion < 2 || !db.objectStoreNames.contains('permissions')) {
                        db.createObjectStore('permissions');
                    }
                    
                    if (oldVersion < 3 || !db.objectStoreNames.contains('appSettings')) {
                        db.createObjectStore('appSettings');
                    }
                };
            });
        };
        
        // Armazena o handle do diretório no IndexedDB para persistência
        async function storeDirectoryHandle(handle) {
            try {
                const db = await openDB();
                const tx = db.transaction('permissions', 'readwrite');
                tx.objectStore('permissions').put(handle, 'directoryHandle');
            } catch (error) {
                console.error('Erro ao salvar o handle do diretório:', error);
            }
        }

        // Recupera o handle do diretório do IndexedDB
        async function getDirectoryHandle() {
            try {
                const db = await openDB();
                return new Promise((resolve) => {
                    const tx = db.transaction('permissions', 'readonly');
                    const request = tx.objectStore('permissions').get('directoryHandle');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (error) {
                console.error('Erro ao recuperar o handle do diretório:', error);
                return null;
            }
        }
        
        // Dados persistentes
        let plants = [];
        let journalEntries = [];
        let selectedPlant = null;
        let selectedEvent = null;
        let currentPage = 0;
        let setups = [];
        const cardsPerPage = 3;
        let totalPages = 0;
        let savedDirectory = 'Plano Diario';
        let directoryHandle = null;
        let npkSettings = {
            vegetative: { n: 10, p: 5, k: 5 },
            flowering: { n: 5, p: 10, k: 15 },
            fruiting: { n: 3, p: 12, k: 18 }
        };
        let currentWateringDate = null; // Para o modal de seleção de rega
        let currentGalleryPhotos = []; // Para a galeria de fotos
        let currentGalleryIndex = 0; // Índice atual na galeria ampliada
        let permissionGranted = false; // Adicionado de volta para consistência
        // Variáveis para a pré-visualização do PDF
        let generatedPdfDataUri = null;
        let generatedPdfFileName = '';

        // Helper function to parse YYYY-MM-DD string as local date to avoid timezone issues.
        function parseLocalDate(dateString) {
            if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return null;
            const [year, month, day] = dateString.split('-').map(Number);
            // Using new Date(year, month-1, day) creates a date at midnight in the local timezone.
            return new Date(year, month - 1, day);
        }

        // Função para mostrar mensagens de status
        function showStatusBar(message, type) {
            const statusBar = document.getElementById('statusBar');
            statusBar.textContent = message;
            statusBar.className = `status-bar ${type}`;
            statusBar.style.display = 'block';
            
            setTimeout(() => {
                statusBar.style.display = 'none';
            }, 5000);
        }
        
        // Configuração do IndexedDB para NPK
        const openNPKDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('NPKSettingsDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('npkSettings')) {
                        db.createObjectStore('npkSettings');
                    }
                };
            });
        };

        // Armazenar configurações de NPK
        async function saveNPKSettingsToDB(settings) {
            try {
                const db = await openNPKDB();
                const tx = db.transaction('npkSettings', 'readwrite');
                tx.objectStore('npkSettings').put(settings, 'currentSettings');
            } catch (error) {
                console.error('Erro ao salvar configurações de NPK:', error);
            }
        }

        // Recuperar configurações de NPK
        async function loadNPKSettingsFromDB() {
            try {
                const db = await openNPKDB();
                return new Promise((resolve) => {
                    const tx = db.transaction('npkSettings', 'readonly');
                    const request = tx.objectStore('npkSettings').get('currentSettings');
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => resolve(null);
                });
            } catch (error) {
                return null;
            }
        }

        // Salvar configurações de NPK
        function saveNPKSettings(e) {
            e.preventDefault();
            
            npkSettings.vegetative = {
                n: parseFloat(document.getElementById('vegN').value) || 10,
                p: parseFloat(document.getElementById('vegP').value) || 5,
                k: parseFloat(document.getElementById('vegK').value) || 5
            };
            
            npkSettings.flowering = {
                n: parseFloat(document.getElementById('flowerN').value) || 5,
                p: parseFloat(document.getElementById('flowerP').value) || 10,
                k: parseFloat(document.getElementById('flowerK').value) || 15
            };
            
            npkSettings.fruiting = {
                n: parseFloat(document.getElementById('fruitN').value) || 3,
                p: parseFloat(document.getElementById('fruitP').value) || 12,
                k: parseFloat(document.getElementById('fruitK').value) || 18
            };
            
            // Salvar no IndexedDB
            saveNPKSettingsToDB(npkSettings);
            showStatusBar('Configurações de NPK salvas com sucesso!', 'success');
            closeConfigModal();
            
            // Atualizar calendário se houver planta selecionada
            if (selectedPlant) {
                renderWateringCalendar(selectedPlant);
            }
        }

        // Mostrar erro de validação
        function showValidationError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Adicionar classe de erro
            field.classList.add('input-error');
            
            // Remover mensagem anterior se existir
            let errorElement = field.nextElementSibling;
            if (errorElement && errorElement.classList.contains('error-message')) {
                errorElement.remove();
            }
            
            // Criar elemento de mensagem
            errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            errorElement.textContent = message;
            field.parentNode.insertBefore(errorElement, field.nextSibling);
        }
        
        // Resetar erros de validação
        function resetValidationErrors() {
            // Remover classes de erro
            document.querySelectorAll('.input-error').forEach(field => {
                field.classList.remove('input-error');
            });
            
            // Remover mensagens de erro
            document.querySelectorAll('.error-message').forEach(element => {
                element.remove();
            });
        }
        
        // Inicializar o sistema de arquivos
        async function initFileSystem() {
            try {
                // 1. Tenta recuperar o handle do diretório do IndexedDB
                const handle = await getDirectoryHandle();
                
                if (handle) {
                    // Verifica se a permissão para o handle ainda é válida
                    if (await verifyPermission(handle, true)) {
                        directoryHandle = handle; // Atribui ao handle global
                        permissionGranted = true;
                        return true; // Sucesso!
                    }
                }
            } catch (error) {
                console.error("Erro ao inicializar sistema de arquivos:", error);
            }
            // Se não houver handle ou a permissão expirou, retorna false
            return false;
        }
        
        // Verificar permissão
        async function verifyPermission(handle, readWrite = false) {
            const options = {};
            if (readWrite) {
                options.mode = 'readwrite';
            }
            
            // Verificar se já temos permissão, se não, solicitar
            if (await handle.queryPermission(options) === 'granted') {
                return true;
            }
            
            // Se não tiver, solicita. Isso pode mostrar um prompt para o usuário.
            if (await handle.requestPermission(options) === 'granted') {
                return true;
            }
            
            return false;
        }
        
        // Solicitar acesso ao sistema de arquivos
        async function requestDirectoryAccess() {
            try {
               // 1. Pedir ao usuário para selecionar um diretório PAI
               const parentHandle = await window.showDirectoryPicker({
                   startIn: 'documents',
                   id: 'plantDiaryParent', // ID para o diretório pai
                   mode: 'readwrite'
               });

               // 2. Tentar obter/criar a pasta "Plano Diário" dentro do diretório selecionado
               const diaryHandle = await parentHandle.getDirectoryHandle('Plano Diário', { create: true });

               // 3. Armazenar o handle da pasta "Plano Diário" no IndexedDB
               await storeDirectoryHandle(diaryHandle);
               
               directoryHandle = diaryHandle; // Atribui o handle da pasta "Plano Diário"
               permissionGranted = true;
               
               showStatusBar('Pasta "Plano Diário" selecionada com sucesso!', 'success');
               return true;
           } catch (error) {
               console.error("Erro ao solicitar acesso ao diretório:", error);
               if (error.name !== 'AbortError') {
                   showStatusBar('Não foi possível acessar a pasta.', 'error');
               }
               return false;
           }
        }
        
        // Salvar imagem no sistema de arquivos
        async function saveImageToFileSystem(imageFile, plant, eventDate) {
            if (!directoryHandle || !permissionGranted) return null;
            
            try {
                // 1. Obter informações para o nome do arquivo
                const plantName = plant.name.replace(/[^a-zA-Z0-9]/g, '_'); // Sanitiza o nome
                const phase = getPlantPhase(plant, eventDate);
                const dateStr = eventDate.replace(/-/g, ''); // Formato YYYYMMDD
                const extension = imageFile.name.split('.').pop() || 'jpg';

                // 2. Construir o nome do arquivo base e verificar se já existe
                const baseFileName = `${plantName}-${phase}-${dateStr}`;
                let finalFileName = `${baseFileName}.${extension}`;
                let counter = 1;

                // Loop para garantir um nome de arquivo único
                while (true) {
                    try {
                        await directoryHandle.getFileHandle(finalFileName, { create: false });
                        finalFileName = `${baseFileName}_${counter++}.${extension}`;
                    } catch (e) {
                        if (e.name === 'NotFoundError') break; // Nome de arquivo disponível
                        else throw e; // Outro erro
                    }
                }

                // 3. Salvar o arquivo
                const fileHandle = await directoryHandle.getFileHandle(finalFileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(imageFile);
                await writable.close();
                return finalFileName;
            } catch (error) {
                console.error("Erro ao salvar imagem:", error);
                showStatusBar('Falha ao salvar a imagem.', 'error');
                return null;
            }
        }
        
        // Carregar imagem do sistema de arquivos
        async function loadImageFromFileSystem(fileName) {
            if (!directoryHandle || !permissionGranted) return null;
            
            try {
                const fileHandle = await directoryHandle.getFileHandle(fileName);
                const file = await fileHandle.getFile();
                return URL.createObjectURL(file);
            } catch (error) {
                console.error("Erro ao carregar imagem:", error);
                return null;
            }
        }
        
        // Helper para obter a imagem como Data URL, seja do sistema de arquivos ou do cache base64
        async function getImageDataUrl(entry) {
            // Prioriza a imagem em base64 se existir (cache)
            if (entry.imageData) {
                return entry.imageData;
            }
            // Se não, tenta carregar do sistema de arquivos
            if (entry.imageFileName && directoryHandle && permissionGranted) {
                try {
                    const fileHandle = await directoryHandle.getFileHandle(entry.imageFileName);
                    const file = await fileHandle.getFile();
                    return await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                } catch (error) {
                    console.error("Erro ao carregar imagem do sistema de arquivos para o PDF:", error);
                    return null;
                }
            }
            return null;
        }

        // Atualizar indicador de pasta
        function updateFolderIndicator() {
            const folderName = document.getElementById('folderName');
            if (folderName) {
                folderName.textContent = savedDirectory;
            }
        }

        // Helper para obter a data local no formato YYYY-MM-DD
        function getLocalDateString(date = new Date()) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Definir data atual como padrão nos formulários
       function setTodayAsDefaultDate() {
            document.getElementById('eventDate').value = getLocalDateString();
}

        // --- LÓGICA DO MODAL DE CONFIGURAÇÃO UNIFICADO ---

        function openConfigModal(initialTab = 'setups') {
            history.pushState({ modal: 'configModal' }, 'Configurações', '#config');
            document.getElementById('configModal').style.display = 'flex';
            switchConfigTab(initialTab);
        }

        function closeConfigModal() {
            document.getElementById('configModal').style.display = 'none';
            // Se o estado atual for o modal, volte para limpar o histórico
            if (history.state && history.state.modal === 'configModal') {
                history.back();
            }
        }

        function switchConfigTab(tabName) {
            // Esconder todos os conteúdos
            document.querySelectorAll('.config-tab-content').forEach(content => content.classList.remove('active'));
            // Desativar todas as abas
            document.querySelectorAll('.config-tab').forEach(tab => tab.classList.remove('active'));

            // Ativar a aba e o conteúdo corretos
            document.getElementById(`${tabName}TabContent`).classList.add('active');
            document.querySelector(`.config-tab[data-tab="${tabName}"]`).classList.add('active');

            // Lógica específica ao abrir a aba
            if (tabName === 'setups') {
                renderSetupsList();
                document.getElementById('saveFertilizerBtn').style.display = 'none';
            } else if (tabName === 'fertilizers') {
                populateNpkForm();
                document.getElementById('saveFertilizerBtn').style.display = 'inline-block';
            }
        }

        function populateNpkForm() {
            document.getElementById('vegN').value = npkSettings.vegetative.n;
            document.getElementById('vegP').value = npkSettings.vegetative.p;
            document.getElementById('vegK').value = npkSettings.vegetative.k;
            document.getElementById('flowerN').value = npkSettings.flowering.n;
            document.getElementById('flowerP').value = npkSettings.flowering.p;
            document.getElementById('flowerK').value = npkSettings.flowering.k;
            document.getElementById('fruitN').value = npkSettings.fruiting.n;
            document.getElementById('fruitP').value = npkSettings.fruiting.p;
            document.getElementById('fruitK').value = npkSettings.fruiting.k;
        }

        // Funções para o modal de seleção de rega
        function openWateringModal(date) {
            history.pushState({ modal: 'wateringModal' }, 'Seleção de Rega', '#watering');
            currentWateringDate = date;
            const dateObj = parseLocalDate(date);
            const formattedDate = dateObj.toLocaleDateString('pt-BR');
            document.getElementById('wateringDateText').textContent = `Para o dia: ${formattedDate}`;
            document.getElementById('wateringModal').style.display = 'flex';
        }

        function closeWateringModal() {
            document.getElementById('wateringModal').style.display = 'none';
            if (history.state && history.state.modal === 'wateringModal') {
                history.back();
            }
        }

        // Funções para o modal de pré-visualização de PDF
        function openPdfPreviewModal(pdfDataUri, fileName) {
            history.pushState({ modal: 'pdfPreviewModal' }, 'Preview PDF', '#pdfpreview');
            generatedPdfDataUri = pdfDataUri;
            generatedPdfFileName = fileName;
            document.getElementById('pdfPreviewFrame').src = pdfDataUri;
            document.getElementById('pdfPreviewModal').style.display = 'flex';
        }

        function closePdfPreviewModal() {
            document.getElementById('pdfPreviewFrame').src = 'about:blank'; // Limpa o iframe
            generatedPdfDataUri = null;
            generatedPdfFileName = '';
            if (history.state && history.state.modal === 'pdfPreviewModal') {
                history.back();
            }
            document.getElementById('pdfPreviewModal').style.display = 'none';
        }

        // Funções para o modal de opções de PDF
        function openPdfOptionsModal() {
            history.pushState({ modal: 'pdfOptionsModal' }, 'Opções PDF', '#pdfoptions');
            if (!selectedPlant) {
                showStatusBar('Selecione uma planta primeiro.', 'error');
                return;
            }
            document.getElementById('pdfTitle').value = `Diário de Cultivo: ${selectedPlant.name}`;
            document.getElementById('pdfOptionsModal').style.display = 'flex';
        }

        function closePdfOptionsModal() {
            if (history.state && history.state.modal === 'pdfOptionsModal') {
                history.back();
            }
            document.getElementById('pdfOptionsModal').style.display = 'none';
        }

        function downloadPdfFromPreview() {
            if (generatedPdfDataUri) {
                const link = document.createElement('a');
                link.href = generatedPdfDataUri;
                link.download = generatedPdfFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Função para marcar rega
        function markWatering(date, type) {
            if (!selectedPlant) {
                showStatusBar('Selecione uma planta primeiro', 'error');
                return;
            }
            
            // Verificar se já existe uma entrada para este dia
            const existingEntry = journalEntries.find(entry => 
                entry.plantId === selectedPlant.id && 
                entry.date === date
            );
            
            if (existingEntry) {
                if (!confirm('Já existe um registro para este dia. Deseja substituir?')) {
                    return;
                }
                
                // Atualizar entrada existente
                existingEntry.watering = type;
                existingEntry.notes = existingEntry.notes || "Rega aplicada conforme calendário";
                existingEntry.title = `Rega - ${type}`;
            } else {
                // Criar novo evento de rega
                const newEvent = {
                    id: String(Date.now()),
                    plantId: selectedPlant.id,
                    date: date,
                    title: `Rega - ${type}`,
                    watering: type,
                    notes: "Rega aplicada conforme calendário",
                    createdAt: new Date().toISOString()
                };
                journalEntries.push(newEvent);
            }
            
            // Atualizar dados e interface
            saveData();
            renderWateringCalendar(selectedPlant);
            loadTimeline(selectedPlant.id);
            
            // Feedback visual
            showStatusBar(`Rega ${type} marcada com sucesso!`, 'success');
        }

        // Renderizar lista de plantas com menu de contexto
        function renderPlantList() {
            const plantList = document.getElementById("plantList");
            plantList.innerHTML = "";

            // Atualizar contador de plantas
            const plantCountEl = document.getElementById('plantCount');
            if (plantCountEl) {
                plantCountEl.textContent = `(${plants.length})`;
            }

            plants.forEach(plant => {
                const today = new Date();
                const germDate = parseLocalDate(plant.germinationDate);
                
                // Corrigido: Adicionar +1 para contar o dia atual corretamente
                const ageInDays = Math.floor((today - germDate) / (1000 * 60 * 60 * 24)) + 1;
                const ageInWeeks = Math.floor(ageInDays / 7) + 1;
                
                // Obter fase atual da planta
                const phase = getPlantPhase(plant);
                const phaseName = getPhaseName(phase);
                const phaseClass = getPhaseClass(phase);

                const setup = setups.find(s => s.id === plant.setupId);
                const lighting = setup ? setup.lighting : 'Não definido';
                const environment = setup ? setup.environment : 'Não definido';

                const plantCard = document.createElement("div");
                const lightDuration = setup ? setup.lightDuration : '';
                plantCard.className = `plant-card ${plant.type}`;
                plantCard.dataset.id = plant.id;
                plantCard.innerHTML = `
                    <div class="plant-name" style="word-break: break-word;">
                        <i class="fas fa-grip-vertical plant-drag-handle" title="Arraste para reordenar"></i>
                        <i class="fas fa-seedling"></i> ${plant.name}
                    </div>
                    <div class="plant-details">
                        <div class="setup-container">
                            <div class="setup-info">
                                <div><i class="fas fa-lightbulb"></i> ${lighting}</div>
                                <div><i class="fas fa-home"></i> ${environment}</div>
                                ${lightDuration ? `<div><i class="fas fa-hourglass-half"></i> ${lightDuration}</div>` : ''}
                            </div>
                        </div>
                        <div class="plant-type ${plant.type === 'auto' ? 'type-auto' : 'type-photo'}">
                            ${plant.type === 'auto' ? 'Automática' : 'Fotoperíodo'}
                        </div>
                        <div class="plant-phase ${phaseClass}">
                            <i class="fas fa-chart-line"></i> ${phaseName}
                        </div>
                    </div>
                    <div class="germination-date">
                        <i class="fas fa-calendar-day"></i> ${parseLocalDate(plant.germinationDate).toLocaleDateString('pt-BR')}
                    </div>
                    <div class="plant-age-container">
                        <div class="plant-age">
                            <i class="fas fa-calendar-day"></i> ${ageInDays} dias
                        </div>
                        <div class="plant-weeks">
                            Semana ${ageInWeeks}
                        </div>
                    </div>
                `;
            
                // Botão de menu de contexto
                const menuBtn = document.createElement("button");
                menuBtn.className = "plant-menu-btn";
                menuBtn.innerHTML = '<i class="fas fa-ellipsis-v"></i>';
                plantCard.appendChild(menuBtn);

                // Menu de contexto
                const menu = document.createElement("div");
                menu.className = "plant-menu";
                menu.innerHTML = `
                    <button class="menu-edit-btn" data-id="${plant.id}">Editar</button>
                    <button class="menu-info-btn" data-id="${plant.id}"><i class="fas fa-info-circle"></i> Infos</button>
                    <button class="menu-phase-btn" data-id="${plant.id}"><i class="fas fa-sync-alt"></i> Mudar Fase</button>
                    <button class="menu-setup-btn" data-id="${plant.id}"><i class="fas fa-cogs"></i> Mudar Setup</button>
                    <button class="menu-delete-btn" data-id="${plant.id}">Excluir</button>
                `;
                plantCard.appendChild(menu);

                // Event listeners para o menu
                menuBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Esconder outros menus
                    document.querySelectorAll('.plant-menu').forEach(m => {
                        if (m !== menu) m.style.display = 'none';
                    });
                    // Mostrar/ocultar este menu
                    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
                });

                menu.querySelector('.menu-info-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const plantId = this.dataset.id;
                    openPlantInfoModal(plantId);
                    menu.style.display = 'none';
                });

                menu.querySelector('.menu-phase-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const plantId = this.dataset.id;
                    openPhaseChangeModal(plantId);
                    menu.style.display = 'none';
                });

                menu.querySelector('.menu-edit-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const plantId = this.dataset.id;
                    editPlant(plantId);
                    menu.style.display = 'none';
                });

                menu.querySelector('.menu-setup-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const plantId = this.dataset.id;
                    selectedPlant = plants.find(p => p.id === plantId); // Garante que a planta está selecionada
                    openSetupChangeModal(plantId);
                    menu.style.display = 'none';
                });

                menu.querySelector('.menu-delete-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const plantId = this.dataset.id;
                    deletePlant(plantId);
                    menu.style.display = 'none';
                });

                plantList.appendChild(plantCard);
            });

            // Calcular páginas para navegação
            totalPages = Math.ceil(plants.length / cardsPerPage);
            updateCarouselNav();
        }

        // Popula um dropdown de setups
        function populateSetupDropdown(dropdownId, selectedId = null) {
            const select = document.getElementById(dropdownId);
            select.innerHTML = '<option value="">Selecione um Setup...</option>'; // Opção padrão

            setups.forEach(setup => {
                const option = document.createElement('option');
                option.value = setup.id;
                option.textContent = setup.name;
                if (setup.id === selectedId) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // Helper para gerar a classe de cor da rega
        function getWateringTypeClass(type) {
            if (!type) return '';
            const sanitized = type.toLowerCase()
                                  .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove acentos
                                  .replace(/\s+/g, '-'); // substitui espaços por hífens
            return `watered-type-${sanitized}`;
        }

        // Renderizar calendário de rega
       function renderWateringCalendar(plant) {
            if (!plant) {
                document.getElementById('wateringCalendar').style.display = 'none';
                return;
            }
        
            document.getElementById('wateringCalendar').style.display = 'block';
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
        
            const germDate = parseLocalDate(plant.germinationDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
        
            const maxDays = 150; // Renderiza um ciclo de vida longo
            let todayCard = null;
        
            for (let i = 0; i < maxDays; i++) {
                const dayDate = new Date(germDate);
                dayDate.setDate(germDate.getDate() + i);
                
                const dayNumber = dayDate.getDate();
                const dayOfWeek = dayDate.toLocaleDateString('pt-BR', { weekday: 'short' });
                const dayAge = i + 1;
                const dateStr = dayDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                
                // Verificar se é o dia atual
                const isToday = dayDate.getTime() === today.getTime();
                
                // Obter fase da planta neste dia
                const phase = getPlantPhase(plant, dateStr);
                const phaseName = getPhaseName(phase);
                const phaseClass = getPhaseClass(phase);

                // Obter recomendações de rega para este dia e fase
                const wateringInfo = getWateringRecommendation(plant, dayAge, phase);

                // Determinar classes e texto para o status da rega
                let statusIconClass = '';
                let statusTextClass = '';
                let statusText = '';

                if (wateringInfo.watered) {
                    const typeClass = getWateringTypeClass(wateringInfo.type);
                    statusIconClass = `watered-icon ${typeClass}`;
                    statusTextClass = typeClass;
                    statusText = wateringInfo.type;
                } else if (wateringInfo.shouldWater) {
                    statusIconClass = 'watering-yes';
                    statusTextClass = 'watering-yes';
                    statusText = 'Rega recomendada';
                } else {
                    statusIconClass = 'watering-no';
                    statusTextClass = 'watering-no';
                    statusText = 'Sem rega hoje';
                }

                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                if (isToday) {
                    dayCard.classList.add('today');
                    todayCard = dayCard; // Guarda referência ao card de hoje
                }

                dayCard.innerHTML = `
                    ${isToday ? '<div class="current-day-indicator">Hoje</div>' : ''}
                    <div class="day-header">
                        <div class="day-number">Dia ${dayAge}</div>
                        <div class="day-phase ${phaseClass}">${phaseName}</div>
                    </div>
                    <div class="watering-info">
                        <div class="watering-status">
                            <i class="fas fa-tint ${statusIconClass}"></i>
                            <span class="${statusTextClass}">${statusText}</span>
                        </div>
                        <div class="watering-values">
                            <div>
                                <span class="watering-label">pH:</span>
                                <span class="watering-value">${wateringInfo.ph}</span>
                            </div>
                            <div>
                                <span class="watering-label">EC:</span>
                                <span class="watering-value">${wateringInfo.ec} mS/cm</span>
                            </div>
                            <div class="watering-npk">
                                NPK: ${wateringInfo.npk}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: #b0b0b0;">
                        ${dayOfWeek}, ${dayDate.toLocaleDateString('pt-BR')}
                    </div>
                    <button class="day-water-btn" data-date="${dateStr}">
                        <i class="fas fa-tint"></i>
                    </button>
                `;
                
                // Verificar se já foi regado neste dia e atualizar o botão
                const btn = dayCard.querySelector('.day-water-btn');
                if (wateringInfo.watered) {
                    btn.classList.add('watered');
                    btn.innerHTML = `<i class="fas fa-check"></i>`;
                } else {
                    btn.classList.remove('watered');
                    btn.innerHTML = `<i class="fas fa-tint"></i>`;
                }
                
                calendarDays.appendChild(dayCard);
            }
        
            // Rola para o card do dia atual, centralizando-o
            if (todayCard) {
                setTimeout(() => {
                    todayCard.scrollIntoView({
                        behavior: 'smooth',
                        inline: 'center',
                        block: 'nearest'
                    });
                }, 100); // Pequeno delay para garantir a renderização
            }
        }

        // Atualiza o indicador de semana com base no scroll
        function updateWeekIndicator() {
            const container = document.querySelector('.calendar-days-container');
            const indicator = document.getElementById('weekIndicator');
            if (!container || !indicator) return;

            const containerRect = container.getBoundingClientRect();
            const containerCenter = containerRect.left + (containerRect.width / 2);

            let centerCard = null;
            let minDistance = Infinity;

            // Encontra o card mais próximo do centro
            container.querySelectorAll('.day-card').forEach(card => {
                const cardRect = card.getBoundingClientRect();
                const cardCenter = cardRect.left + (cardRect.width / 2);
                const distance = Math.abs(containerCenter - cardCenter);

                if (distance < minDistance) {
                    minDistance = distance;
                    centerCard = card;
                }
            });

            if (centerCard) {
                const dayAgeText = centerCard.querySelector('.day-number').textContent;
                const dayAge = parseInt(dayAgeText.replace('Dia ', ''));
                if (!isNaN(dayAge)) {
                    const weekNumber = Math.floor((dayAge - 1) / 7) + 1;
                    indicator.textContent = `S${weekNumber}`;
                }
            }
        }

        // Obter recomendações de rega baseadas na fase e idade da planta
        function getWateringRecommendation(plant, dayAge, phase) {
            const isAuto = plant.type === 'auto';
            let shouldWater = false;
            let ph = '6.0-6.5';
            let ec = '1.0-1.2';
            
            // Obter configuração de NPK para a fase
            let npkValue = "";
            if (phase === "vegetative") {
                npkValue = `${npkSettings.vegetative.n}-${npkSettings.vegetative.p}-${npkSettings.vegetative.k}`;
            } 
            else if (phase === "flowering") {
                npkValue = `${npkSettings.flowering.n}-${npkSettings.flowering.p}-${npkSettings.flowering.k}`;
            } 
            else if (phase === "fruiting") {
                npkValue = `${npkSettings.fruiting.n}-${npkSettings.fruiting.p}-${npkSettings.fruiting.k}`;
            }
            else {
                // Fase padrão
                npkValue = `${npkSettings.vegetative.n}-${npkSettings.vegetative.p}-${npkSettings.vegetative.k}`;
            }
            
            // Dias pares - rega, dias ímpares - descanso (para exemplo)
            shouldWater = dayAge % 2 === 0;
            
            // Ajustar valores baseados na fase
            switch(phase) {
                case 'vegetative':
                    ph = isAuto ? '5.8-6.2' : '5.8-6.3';
                    ec = isAuto ? '0.8-1.2' : '1.0-1.4';
                    break;
                case 'preflower':
                    ph = '5.8-6.2';
                    ec = '1.2-1.6';
                    break;
                case 'flowering':
                    ph = '6.0-6.5';
                    ec = '1.4-1.8';
                    break;
                case 'fruiting':
                    ph = '6.0-6.5';
                    ec = '1.2-1.6';
                    break;
                default:
                    ph = '6.0-6.5';
                    ec = '1.0-1.4';
            }
            
            // Verificar se há registro de rega neste dia
            const dayDate = parseLocalDate(plant.germinationDate);
            dayDate.setDate(dayDate.getDate() + dayAge - 1); // Ajuste para dia correto
            const dayStr = dayDate.toISOString().split('T')[0];
            
            const wateringEntry = journalEntries.find(entry => 
                entry.plantId === plant.id && 
                entry.date === dayStr && 
                entry.watering
            );
            
            if (wateringEntry) {
                return {
                    watered: true,
                    type: wateringEntry.watering,
                    ph: wateringEntry.ph || ph,
                    ec: wateringEntry.ec || ec,
                    npk: npkValue
                };
            }
            
            return {
                shouldWater,
                ph,
                ec,
                npk: npkValue
            };
        }

        // Atualizar navegação do carrossel
        function updateCarouselNav() {
            const navContainer = document.querySelector('.carousel-nav');
            navContainer.innerHTML = '';
            
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('div');
                dot.className = `nav-dot ${i === currentPage ? 'active' : ''}`;
                dot.dataset.page = i;
                dot.addEventListener('click', () => {
                    currentPage = i;
                    updateCarouselPosition();
                    updateCarouselNav();
                });
                navContainer.appendChild(dot);
            }
        }

        // Atualizar posição do carrossel
        function updateCarouselPosition() {
            const plantList = document.getElementById("plantList");
            const scrollPosition = currentPage * (220 + 15) * cardsPerPage;
            plantList.scrollTo({
                left: scrollPosition,
                behavior: 'smooth'
            });
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Seleção de planta
            document.getElementById('plantList').addEventListener('click', function(e) {
                const card = e.target.closest('.plant-card');
                if (card) {
                    const plantId = card.dataset.id;
                    const plant = plants.find(p => p.id === plantId);
                    
                    if (plant) {
                        // Remover seleção de outras plantas
                        document.querySelectorAll('.plant-card').forEach(c => {
                            c.classList.remove('selected');
                        });
                        
                        // Adicionar seleção atual
                        card.classList.add('selected');
                        
                        // Carregar linha do tempo
                        loadTimeline(plantId);
                        selectedPlant = plant;
                        
                        // Renderizar calendário de rega (que agora rola para o dia atual)
                        renderWateringCalendar(plant);
                        
                        // Atualizar título da linha do tempo apenas com o nome da planta
                        document.getElementById('plantNameTitle').textContent = plant.name;
                    }
                }
                
                // Deleção de planta
                if (e.target.closest('.delete-plant-btn')) {
                    const btn = e.target.closest('.delete-plant-btn');
                    const plantId = btn.dataset.id;
                    deletePlant(plantId);
                    return;
                }
                
                // Edição de planta
                if (e.target.closest('.edit-plant-btn')) {
                    const btn = e.target.closest('.edit-plant-btn');
                    const plantId = btn.dataset.id;
                    editPlant(plantId);
                    return;
                }
            });

            // Botões de navegação do carrossel
            document.querySelector('.prev-btn').addEventListener('click', () => {
                const plantList = document.getElementById("plantList");
                plantList.scrollBy({ left: -235, behavior: 'smooth' }); // 220px card + 15px gap
            });

            document.querySelector('.next-btn').addEventListener('click', () => {
                const plantList = document.getElementById("plantList");
                plantList.scrollBy({ left: 235, behavior: 'smooth' });
            });

            const calendarContainer = document.querySelector('.calendar-days-container');
            const dayCardWidth = 120 + 10; // min-width do card + gap

            // Botões de navegação do calendário
            document.getElementById('prevWeekBtn').addEventListener('click', () => {
                calendarContainer.scrollBy({ left: -7 * dayCardWidth, behavior: 'smooth' });
            });

            document.getElementById('nextWeekBtn').addEventListener('click', () => {
                calendarContainer.scrollBy({ left: 7 * dayCardWidth, behavior: 'smooth' });
            });

            // Atualiza o indicador de semana durante o scroll (com debounce)
            let scrollTimeout;
            calendarContainer.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateWeekIndicator, 150);
            });

            // Event listener para botões de rega rápida
            document.getElementById('calendarDays').addEventListener('click', function(e) {
                const btn = e.target.closest('.day-water-btn');
                if (btn) {
                    const date = btn.dataset.date;
                    openWateringModal(date);
                }
            });

            // Event listeners para o modal de seleção de rega
            document.querySelectorAll('.watering-option').forEach(option => {
                option.addEventListener('click', function() {
                    const type = this.dataset.type;
                    markWatering(currentWateringDate, type);
                    closeWateringModal();
                });
            });

            // Botões de ação
            document.getElementById('exportTimelineBtn').addEventListener('click', openPdfOptionsModal);
            document.getElementById('addEventBtn').addEventListener('click', addNewEvent);
            document.getElementById('addPlantBtn').addEventListener('click', addNewPlant);
            document.getElementById('selectFolderBtn').addEventListener('click', selectDirectory);
            document.getElementById('deleteEventBtn').addEventListener('click', deleteEvent);
            document.getElementById('deletePlantBtn').addEventListener('click', deletePlantFromModal);
            
            document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdfFromPreview);
            // Formulário de evento
            document.getElementById('eventForm').addEventListener('submit', saveEvent);

            // Formulário de opções de PDF
            document.getElementById('pdfOptionsForm').addEventListener('submit', generatePdfWithOptions);
            
            // Preview de imagem
            document.getElementById('eventImage').addEventListener('change', previewImage);
            
            // Formulário de planta
            document.getElementById('plantForm').addEventListener('submit', savePlant);

            // Formulário de mudança de setup
            document.getElementById('setupChangeForm').addEventListener('submit', saveSetupChange);
            
            // Botões de ação
            document.getElementById('actionButtons').addEventListener('click', function(e) {
                const button = e.target.closest('.action-button');
                if (button) {
                    button.classList.toggle('selected');

                    // Show/hide harvest fields
                    const harvestButton = document.querySelector('.action-button[data-action="Colheita"]');
                    const harvestFields = document.getElementById('harvestFields');
                    if (harvestButton && harvestFields) {
                        harvestFields.style.display = harvestButton.classList.contains('selected') ? 'block' : 'none';
                    }
                }
            });
            
            // Conceder permissão (COM INDEXEDDB)
            document.getElementById('grantPermissionBtn').addEventListener('click', async () => {
                const granted = await requestDirectoryAccess();

                if (granted) {
                    document.getElementById('permissionRequest').style.display = 'none';
                    showStatusBar("Permissão concedida! As imagens serão salvas no sistema de arquivos.", 'success');
                }
            });
            
            document.getElementById('denyPermissionBtn').addEventListener('click', () => {
                document.getElementById('permissionRequest').style.display = 'none';
                showStatusBar("Permissão negada. As imagens serão salvas apenas temporariamente.", 'error');
            });

            // Botão de configuração
            document.getElementById('configBtn').addEventListener('click', () => openConfigModal('setups'));
            document.getElementById('configureNPKBtn').addEventListener('click', () => openConfigModal('fertilizers'));

            // Abas do modal de configuração
            document.querySelectorAll('.config-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchConfigTab(this.dataset.tab);
                });
            });
            
            // Formulário de NPK
            document.getElementById('npkForm').addEventListener('submit', saveNPKSettings);
            
            // Menus de contexto
            document.addEventListener('click', function(e) {
                // Fechar menus de contexto da timeline quando clicar fora
                if (!e.target.closest('.event-menu-btn') && !e.target.closest('.event-menu')) {
                    document.querySelectorAll('.event-menu').forEach(menu => {
                        menu.style.display = 'none';
                    });
                }

                // Fechar menus de contexto dos cards de planta quando clicar fora
                if (!e.target.closest('.plant-menu-btn') && !e.target.closest('.plant-menu')) {
                    document.querySelectorAll('.plant-menu').forEach(menu => menu.style.display = 'none');
                }
                
                // Abrir menu de contexto do evento
                const menuBtn = e.target.closest('.event-menu-btn');
                if (menuBtn) {
                    const menu = menuBtn.nextElementSibling;
                    // Esconder outros menus
                    document.querySelectorAll('.event-menu').forEach(m => {
                        if (m !== menu) m.style.display = 'none';
                    });
                    // Mostrar/ocultar este menu
                    menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
                }
            });

            // Navegação na galeria ampliada
            document.getElementById('prevPhotoBtn').addEventListener('click', () => {
                navigateGallery(-1);
            });

            document.getElementById('nextPhotoBtn').addEventListener('click', () => {
                navigateGallery(1);
            });

            // --- Event Listeners para o formulário de Setups ---
            document.getElementById('setupForm').addEventListener('submit', handleSetupFormSubmit);

            document.getElementById('setupsList').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-setup-btn');
                if (editBtn) {
                    editSetup(editBtn.dataset.id);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-setup-btn');
                if (deleteBtn) {
                    deleteSetup(deleteBtn.dataset.id);
                    return;
                }
            });

            // Fechar modais ao clicar no fundo
            window.addEventListener('click', (event) => {
                const eventModal = document.getElementById('eventModal');
                const plantModal = document.getElementById('plantModal');
                const imageModal = document.getElementById('imageModal');
                const setupChangeModal = document.getElementById('setupChangeModal');
                const phaseChangeModal = document.getElementById('phaseChangeModal');
                const plantInfoModal = document.getElementById('plantInfoModal');
                const permissionRequest = document.getElementById('permissionRequest');
                const configModal = document.getElementById('configModal');
                const wateringModal = document.getElementById('wateringModal');
                const pdfPreviewModal = document.getElementById('pdfPreviewModal');
                const pdfOptionsModal = document.getElementById('pdfOptionsModal');
                const galleryModal = document.getElementById('galleryModal');

                if (event.target === eventModal) closeEventModal();
                if (event.target === plantModal) closePlantModal();
                if (event.target === imageModal) closeImageModal();
                if (event.target === phaseChangeModal) closePhaseChangeModal();
                if (event.target === setupChangeModal) closeSetupChangeModal();
                if (event.target === plantInfoModal) closePlantInfoModal();
                if (event.target === permissionRequest) permissionRequest.style.display = 'none';
                if (event.target === configModal) closeConfigModal();
                if (event.target === wateringModal) closeWateringModal();
                if (event.target === pdfPreviewModal) closePdfPreviewModal();
                if (event.target === pdfOptionsModal) closePdfOptionsModal();
                if (event.target === galleryModal) closeGalleryModal();
            });

            // Helper para fechar todos os modais
            function closeAllModals() {
                document.querySelectorAll('.event-modal, .image-modal, .watering-modal, .gallery-modal, .permission-request').forEach(modal => {
                    modal.style.display = 'none';
                });
            }

            // --- MANIPULADOR DO BOTÃO VOLTAR DO ANDROID ---
            window.onpopstate = function(event) {
                // Primeiro, fechamos qualquer modal que possa estar aberto.
                closeAllModals();

                // Se o estado que recebemos NÃO é a nossa 'barreira' de raiz do app,
                // significa que o usuário voltou para o estado inicial (antes da barreira).
                // Então, nós re-inserimos a barreira para impedir a saída na próxima vez.
                if (!event.state || !event.state.app_root) {
                    history.pushState({ app_root: true }, '');
                }
            };

            // Formulário de mudança de fase
            document.getElementById('phaseChangeForm').addEventListener('submit', savePhaseChange);

            // Formulário de mudança de fase
            document.getElementById('phaseChangeForm').addEventListener('submit', savePhaseChange);

            // Atualiza a seleção visual do tipo de planta no modal
            document.getElementById('plantModal').addEventListener('change', (e) => {
                if (e.target.name === 'plantType') {
                    updatePlantTypeSelection();
                }
            });
        }

        // Função para selecionar pasta
        function selectDirectory() {
            savedDirectory = prompt("Digite o nome da pasta para salvar os dados:", savedDirectory) || savedDirectory;
            localStorage.setItem('selectedDirectory', savedDirectory);
            updateFolderIndicator();
            showStatusBar(`Pasta "${savedDirectory}" selecionada! Os dados serão salvos aqui.`, 'success');
        }

        // Função para deletar planta
        function deletePlant(plantId) {
            if (!confirm('Tem certeza que deseja excluir esta planta e todos os seus registros?')) {
                return;
            }
            
            // Remover planta
            const plantIndex = plants.findIndex(p => p.id === plantId);
            if (plantIndex === -1) return;
            
            plants.splice(plantIndex, 1);
            
            // Remover registros associados
            for (let i = journalEntries.length - 1; i >= 0; i--) {
                if (journalEntries[i].plantId === plantId) {
                    journalEntries.splice(i, 1);
                }
            }
            
            // Atualizar UI
            renderPlantList();
            renderEnvironmentsSummary();
            saveData();
            
            // Se a planta excluída era a selecionada
            if (selectedPlant && selectedPlant.id === plantId) {
                selectedPlant = null;
                document.getElementById("timelineContainer").classList.remove('has-plant');
                document.getElementById('timelineContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>Selecione uma planta para visualizar sua linha do tempo</p>
                        <p>Os eventos de cultivo serão exibidos aqui</p>
                    </div>
                `;
                document.getElementById('plantNameTitle').textContent = '';
                document.getElementById('photoGallery').style.display = 'none';
            }
            
            showStatusBar('Planta excluída com sucesso!', 'success');
        }

        // Abrir modal para nova planta
        function addNewPlant() {
            history.pushState({ modal: 'plantModal' }, 'Nova Planta', '#plant');
            document.getElementById('plantModalTitle').textContent = "Nova Planta";
            document.getElementById('plantForm').reset();
            document.getElementById('deletePlantBtn').style.display = 'none';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('germinationDate').value = today;
            populateSetupDropdown('plantSetup'); // Popula o dropdown
            document.getElementById('plantModal').style.display = 'flex';
        }

        // Abrir modal para editar planta
        function editPlant(plantId) {
            history.pushState({ modal: 'plantModal' }, 'Editar Planta', '#plant');
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;
            
            // Popular dropdown de setups
            populateSetupDropdown('plantSetup', plant.setupId);

            document.getElementById('plantModalTitle').textContent = "Editar Planta";
            document.getElementById('plantId').value = plant.id;
            document.getElementById('plantName').value = plant.name;
            document.getElementById('plantGenetics').value = plant.genetics || '';
            document.getElementById('germinationDate').value = plant.germinationDate;
            
            // Definir tipo de planta
            document.querySelectorAll('input[name="plantType"]').forEach(radio => {
                radio.checked = (radio.value === plant.type);
            });
            
            document.getElementById('deletePlantBtn').style.display = 'inline-block';
            document.getElementById('deletePlantBtn').dataset.id = plantId;
            document.getElementById('plantModal').style.display = 'flex';
        }

        // Fechar modal de planta
        function closePlantModal() {
            if (history.state && history.state.modal === 'plantModal') {
                history.back();
            }
            document.getElementById('plantModal').style.display = 'none';
        }

        // Abrir modal para Mudança de Fase
        function openPhaseChangeModal(plantId) {
            history.pushState({ modal: 'phaseChangeModal' }, 'Mudar Fase', '#phasechange');
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            document.getElementById('phaseChangePlantId').value = plantId;

            // Obter fase atual
            const currentPhase = getPlantPhase(plant);
            const currentPhaseName = getPhaseName(currentPhase);
            document.getElementById('currentPhaseText').textContent = currentPhaseName;

            // Definir data atual como padrão
            document.getElementById('phaseChangeDate').value = getLocalDateString();

            document.getElementById('phaseChangeModal').style.display = 'flex';
        }

        // Fechar modal de mudança de fase
        function closePhaseChangeModal() {
            if (history.state && history.state.modal === 'phaseChangeModal') {
                history.back();
            }
            document.getElementById('phaseChangeModal').style.display = 'none';
        }

        // Salvar mudança de fase
        function savePhaseChange(e) {
            e.preventDefault();
            const plantId = document.getElementById('phaseChangePlantId').value;
            const newPhase = document.getElementById('newPhaseSelect').value;
            const changeDate = document.getElementById('phaseChangeDate').value;

            const plant = plants.find(p => p.id === plantId);
            if (!plant || !newPhase || !changeDate) return;

            if (!plant.phaseChanges) plant.phaseChanges = [];
            plant.phaseChanges.push({ date: changeDate, phase: newPhase });
            plant.phaseChanges.sort((a, b) => new Date(a.date) - new Date(b.date));

            journalEntries.push({ id: String(Date.now()), plantId: plant.id, date: changeDate, title: `Mudança de Fase para ${getPhaseName(newPhase)}`, notes: `A planta entrou na fase de ${getPhaseName(newPhase)}.`, createdAt: new Date().toISOString() });

            saveData();
            renderPlantList();
            loadTimeline(plant.id);

            // Se a planta alterada for a que está selecionada, atualiza o calendário
            if (selectedPlant && selectedPlant.id === plant.id) {
                renderWateringCalendar(plant);
            }

            closePhaseChangeModal();
            showStatusBar('Fase da planta atualizada com sucesso!', 'success');
        }

        // Abrir modal para mudar setup
        function openSetupChangeModal(plantId) {
            history.pushState({ modal: 'setupChangeModal' }, 'Mudar Setup', '#setupchange');
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            populateSetupDropdown('newPlantSetupSelect', plant.setupId);

            document.getElementById('setupChangePlantId').value = plantId;

            document.getElementById('setupChangeModal').style.display = 'flex';
        }

        // Fechar modal de mudar setup
        function closeSetupChangeModal() {
            if (history.state && history.state.modal === 'setupChangeModal') {
                history.back();
            }
            document.getElementById('setupChangeModal').style.display = 'none';
        }

        // Salvar mudança de setup
        function saveSetupChange(e) {
            e.preventDefault();
            const plantId = document.getElementById('setupChangePlantId').value;
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            const newSetupId = document.getElementById('newPlantSetupSelect').value;
            const oldSetup = setups.find(s => s.id === plant.setupId);
            const newSetup = setups.find(s => s.id === newSetupId);

            if (!newSetup || plant.setupId === newSetupId) {
                showStatusBar('Nenhuma mudança de setup foi selecionada.', 'error');
                return;
            }

            const oldSetupName = oldSetup ? oldSetup.name : 'Nenhum';
            const newSetupName = newSetup.name;
            let changeDescription = `Setup da planta alterado de "${oldSetupName}" para "${newSetupName}".`;

            // Criar um novo evento no diário para registrar a mudança
            const newEvent = {
                id: String(Date.now()),
                plantId: plant.id,
                date: getLocalDateString(), // Data de hoje (local)
                title: `Mudança de Setup para ${newSetupName}`,
                notes: changeDescription.trim(),
                createdAt: new Date().toISOString()
            };
            journalEntries.push(newEvent);

            // BUG FIX: Atualizar o setupId da planta para refletir a mudança
            plant.setupId = newSetupId;

            // Atualizar dados e UI
            saveData();
            renderEnvironmentsSummary();
            renderPlantList(); // Para atualizar o card da planta com as novas informações
            loadTimeline(plant.id); // Para mostrar o novo evento
            closeSetupChangeModal();
            showStatusBar('Setup da planta atualizado com sucesso!', 'success');
        }

        // Abrir modal de informações da planta
        async function openPlantInfoModal(plantId) {
            history.pushState({ modal: 'plantInfoModal' }, 'Informações', '#info');
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            const modal = document.getElementById('plantInfoModal');
            const content = document.getElementById('plantInfoContent');
            content.innerHTML = '<p>Carregando informações...</p>';
            modal.style.display = 'flex';

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const germDate = parseLocalDate(plant.germinationDate);
            const plantEntries = journalEntries.filter(e => e.plantId === plant.id);

            // --- 1. Informações Gerais ---
            const ageInDays = Math.floor((today - germDate) / (1000 * 60 * 60 * 24)) + 1;
            const currentPhase = getPhaseName(getPlantPhase(plant));
            const plantTypeDisplay = plant.type === 'auto' ? 'Automática' : 'Fotoperíodo';
            const genetics = plant.genetics || 'Não especificada';
            const currentSetup = setups.find(s => s.id === plant.setupId);

            const generalInfoHtml = `
                <div class="info-section">
                    <h3><i class="fas fa-info-circle"></i> Informações Gerais</h3>
                    <div class="info-grid">
                        <div class="info-item"><span class="label">Nome</span><span class="value">${plant.name}</span></div>
                        <div class="info-item"><span class="label">Genética</span><span class="value">${genetics}</span></div>
                        <div class="info-item"><span class="label">Germinação</span><span class="value">${germDate.toLocaleDateString('pt-BR')}</span></div>
                        <div class="info-item"><span class="label">Tipo</span><span class="value">${plantTypeDisplay}</span></div>
                        <div class="info-item"><span class="label">Idade</span><span class="value">${ageInDays} dias</span></div>
                        <div class="info-item"><span class="label">Fase Atual</span><span class="value">${currentPhase}</span></div>
                        ${currentSetup ? `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <span class="label">Setup Atual</span>
                            <span class="value">${currentSetup.name} (${currentSetup.lighting} / ${currentSetup.environment} ${currentSetup.lightDuration ? `/ ${currentSetup.lightDuration}` : ''})</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // --- 2. Resumo da Colheita ---
            const harvestEntries = plantEntries.filter(e => e.action && e.action.includes('Colheita'));
            const totalWetWeight = harvestEntries.reduce((sum, entry) => sum + (parseFloat(entry.wetWeight) || 0), 0);
            const totalDryWeight = harvestEntries.reduce((sum, entry) => sum + (parseFloat(entry.dryWeight) || 0), 0);

            let harvestSummaryHtml = `
                <div class="info-section">
                    <h3><i class="fas fa-cannabis"></i> Resumo da Colheita</h3>
            `;
            if (harvestEntries.length > 0) {
                harvestSummaryHtml += `
                    <div class="info-grid">
                        <div class="info-item"><span class="label">Peso Úmido Total</span><span class="value">${totalWetWeight.toFixed(2)} g</span></div>
                        <div class="info-item"><span class="label">Peso Seco Total</span><span class="value">${totalDryWeight.toFixed(2)} g</span></div>
                    </div>
                `;
            } else {
                harvestSummaryHtml += `<div class="info-list"><ul><li>Nenhuma colheita registrada.</li></ul></div>`;
            }
            harvestSummaryHtml += `</div>`;

            // --- 3. Estatísticas de Rega ---
            const wateringEntries = plantEntries.filter(e => e.watering);
            const wateringCounts = wateringEntries.reduce((acc, entry) => {
                acc[entry.watering] = (acc[entry.watering] || 0) + 1;
                return acc;
            }, {});

            const wateringStatsHtml = `
                <div class="info-section">
                    <h3><i class="fas fa-tint"></i> Estatísticas de Rega</h3>
                    <div class="info-list">
                        <ul>
                            <li>Total de Regas: <strong>${wateringEntries.length}</strong></li>
                            ${Object.entries(wateringCounts).map(([type, count]) => `<li>${type}: <strong>${count}</strong></li>`).join('') || '<li>Nenhuma rega registrada.</li>'}
                        </ul>
                    </div>
                </div>
            `;

            // --- 4. Histórico de Setup ---
            const setupHistoryCalc = {};
            const changeEvents = plantEntries
                .filter(e => e.title && e.title.startsWith('Mudança de Setup para '))
                .sort((a, b) => parseLocalDate(a.date) - parseLocalDate(b.date));

            let lastDate = germDate;
            let lastSetupId = plant.setupId; 

            const reversedEvents = [...changeEvents].reverse();
            let initialSetupId = plant.setupId;
            for (const event of reversedEvents) {
                const oldSetupName = event.notes.match(/de "(.*?)" para/)?.[1];
                const oldSetup = setups.find(s => s.name === oldSetupName);
                if (oldSetup) {
                    initialSetupId = oldSetup.id;
                }
            }

            lastSetupId = initialSetupId;

            changeEvents.forEach(event => {
                const eventDate = parseLocalDate(event.date);
                const duration = Math.round((eventDate - lastDate) / (1000 * 60 * 60 * 24));
                if (duration > 0) {
                    setupHistoryCalc[lastSetupId] = (setupHistoryCalc[lastSetupId] || 0) + duration;
                }
                const newSetupName = event.title.replace('Mudança de Setup para ', '');
                const newSetup = setups.find(s => s.name === newSetupName);
                lastSetupId = newSetup ? newSetup.id : lastSetupId;
                lastDate = eventDate;
            });

            const finalDuration = Math.round((today - lastDate) / (1000 * 60 * 60 * 24));
            if (finalDuration >= 0) { // Inclui 0 dias
                setupHistoryCalc[lastSetupId] = (setupHistoryCalc[lastSetupId] || 0) + finalDuration + 1; // Adiciona 1 para incluir o dia atual
            }

            const setupHistoryHtml = `
                <div class="info-section">
                    <h3><i class="fas fa-cogs"></i> Histórico de Setup</h3>
                    <div class="info-list">
                        <ul>
                            ${Object.entries(setupHistoryCalc).map(([setupId, days]) => {
                                const setup = setups.find(s => s.id === setupId);
                                return `<li>${setup ? setup.name : 'Desconhecido'}: <strong>${days} dia${days !== 1 ? 's' : ''}</strong></li>`;
                            }).join('') || '<li>Nenhum histórico de setup.</li>'}
                        </ul>
                    </div>
                </div>
            `;

            // --- 5. Ações Realizadas ---
            const actionCounts = plantEntries.reduce((acc, entry) => {
                if (entry.action) {
                    entry.action.split(',').map(a => a.trim()).forEach(action => {
                        if (action) acc[action] = (acc[action] || 0) + 1;
                    });
                }
                return acc;
            }, {});

            const actionsHtml = `
                <div class="info-section">
                    <h3><i class="fas fa-tasks"></i> Ações Realizadas</h3>
                    <div class="info-list">
                        <ul>
                            ${Object.entries(actionCounts).map(([action, count]) => `<li>${action}: <strong>${count}</strong></li>`).join('') || '<li>Nenhuma ação registrada.</li>'}
                        </ul>
                    </div>
                </div>
            `;

            content.innerHTML = generalInfoHtml + harvestSummaryHtml + wateringStatsHtml + setupHistoryHtml + actionsHtml;
        }

        function closePlantInfoModal() {
            if (history.state && history.state.modal === 'plantInfoModal') {
                history.back();
            }
            document.getElementById('plantInfoModal').style.display = 'none';
        }

        // Salvar planta
        function savePlant(e) {
            e.preventDefault();
            const plantId = document.getElementById('plantId').value;
            const name = document.getElementById('plantName').value.trim();
            const germinationDate = document.getElementById('germinationDate').value;
            const setupId = document.getElementById('plantSetup').value;
            const type = document.querySelector('input[name="plantType"]:checked').value;
            const genetics = document.getElementById('plantGenetics').value.trim();

            if (!name || !germinationDate || !setupId) {
                alert("Preencha todos os campos obrigatórios!");
                return;
            }

            if (plantId) {
                // Editar planta existente
                const plantIndex = plants.findIndex(p => p.id === plantId);
                if (plantIndex !== -1) {
                    plants[plantIndex] = {
                        ...plants[plantIndex],
                        name,
                        genetics,
                        germinationDate,
                        type,
                        setupId: setupId
                    };
                }
            } else {
                // Criar nova planta
                const newId = String(Date.now());
                const newPlant = {
                    id: newId,
                    name,
                    genetics,
                    type,
                    germinationDate,
                    setupId: setupId,
                    createdAt: new Date().toISOString()
                };
                plants.push(newPlant);
            }
            
            renderPlantList();
            renderEnvironmentsSummary();
            closePlantModal();
            saveData();
            showStatusBar(`Planta ${plantId ? 'atualizada' : 'salva'} com sucesso!`, 'success');
        }

        // Deletar planta a partir do modal
        function deletePlantFromModal() {
            const plantId = document.getElementById('deletePlantBtn').dataset.id;
            closePlantModal();
            deletePlant(plantId);
        }

        // Renderizar resumo dos ambientes
        function renderEnvironmentsSummary() {
            const summaryContainer = document.getElementById('environmentsSummary');
            if (!summaryContainer) return;

            summaryContainer.innerHTML = `
                <h3><i class="fas fa-home"></i> Ambientes</h3>
                <div class="environment-grid" id="environmentGrid"></div>
            `;

            const grid = document.getElementById('environmentGrid');

            if (setups.length === 0) {
                grid.innerHTML = '<p style="color: #b0b0b0;">Nenhum setup cadastrado. Crie um nas configurações.</p>';
                return;
            }

            setups.forEach(setup => {
                const plantCount = plants.filter(plant => plant.setupId === setup.id).length;

                const item = document.createElement('div');
                item.className = 'environment-item';
                item.innerHTML = `
                    <div class="environment-name">${setup.name}</div>
                    <div class="environment-details">
                        <i class="fas fa-seedling"></i> 
                        <span class="environment-plant-count" style="font-weight: bold; color: var(--secondary);">${plantCount}</span> 
                        planta${plantCount !== 1 ? 's' : ''}
                    </div>
                `;
                grid.appendChild(item);
            });
        }

        // Carregar linha do tempo
        async function loadTimeline(plantId) {
            const timelineContainer = document.getElementById("timelineContainer");
            timelineContainer.innerHTML = "";

            // Adicionar classe para mostrar linha central
            timelineContainer.classList.add('has-plant');
    
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;

            // Obter registros da planta
            const plantEntries = journalEntries.filter(entry => entry.plantId === plantId);
            
            // Ordenar por data (mais antigo primeiro)
            plantEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Carregar galeria de fotos
            loadPhotoGallery(plantId);
            
            if (plantEntries.length === 0) {
                timelineContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-book-open"></i>
                        <p>Nenhum evento registrado para esta planta</p>
                        <p>Adicione eventos para acompanhar seu desenvolvimento</p>
                    </div>
                `;
                return;
            }
            
            // Obter a data atual
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Set to local midnight
            
            // Calcular idade da planta
            const germDate = parseLocalDate(plant.germinationDate);
            const ageInDays = Math.floor((today - germDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // Adicionar evento de germinação
            const germinationEvent = {
                id: "germination",
                plantId: plant.id,
                date: plant.germinationDate,
                title: "Germinação",
                notes: "Semente plantada e início do processo de germinação",
                icon: "fas fa-seedling",
                iconClass: "vegetative-icon"
            };
            
            const initialSetup = setups.find(s => s.id === plant.setupId);
            if(initialSetup) {
                germinationEvent.lighting = initialSetup.lighting;
                germinationEvent.environment = initialSetup.environment;
            }
            // Ordenar eventos do mais recente para o mais antigo (invertendo a ordem)
const timelineEvents = [germinationEvent, ...plantEntries].sort((a, b) => new Date(b.date) - new Date(a.date));

            // Gerar elementos da linha do tempo
            for (const entry of timelineEvents) {
                const eventDate = parseLocalDate(entry.date);
                const formattedDate = eventDate.toLocaleDateString("pt-BR");
                
                const daysSinceGermination = Math.floor(
                    (eventDate - germDate) / (1000 * 60 * 60 * 24) + 1
                );
                
                // Verificar se é o evento atual (hoje)
                const isCurrent = eventDate.getTime() === today.getTime();
                
                // Calcular fase da planta
                const phase = getPlantPhase(plant, entry.date);
                const phaseName = getPhaseName(phase);
                const phaseClass = getPhaseClass(phase);
                
                // --- Início da nova lógica para duração do setup ---
                let setupDurationText = '';
                if (entry.id === 'germination') {
                    setupDurationText = 'Início do cultivo';
                } else if (entry.lighting || entry.environment) {
                    // 1. Coletar todos os pontos de mudança de setup (germinação e eventos de mudança)
                    const setupChangePoints = [
                        { date: plant.germinationDate },
                        ...plantEntries.filter(e => e.title === "Mudança de Setup")
                    ];

                    // 2. Encontrar o ponto de mudança mais recente que ocorreu em ou antes da data do evento atual
                    const relevantChangePoint = setupChangePoints
                        .filter(p => parseLocalDate(p.date) <= eventDate)
                        .sort((a, b) => parseLocalDate(b.date) - parseLocalDate(a.date))[0];

                    // 3. Calcular a duração
                    if (relevantChangePoint) {
                        const setupStartDate = parseLocalDate(relevantChangePoint.date);
                        // A duração é da data de início do setup até a data do evento atual
                        const durationInDays = Math.round((eventDate - setupStartDate) / (1000 * 60 * 60 * 24));
                        
                        if (durationInDays < 1) {
                            setupDurationText = 'Setup iniciado neste dia';
                        } else {
                            setupDurationText = `Ativo por ${durationInDays} dia${durationInDays > 1 ? 's' : ''}`;
                        }
                    }
                }
                // --- Fim da nova lógica ---

                // Gerar info de setup do evento
                let setupInfoHtml = "";
                if (entry.lighting || entry.environment) {
                    setupInfoHtml = `
                        <div class="event-setup-info">
                            ${entry.lighting ? `<div><i class="fas fa-lightbulb"></i> ${entry.lighting}</div>` : ''}
                            ${entry.lightDuration ? `<div><i class="fas fa-hourglass-half"></i> ${entry.lightDuration}</div>` : ''}
                            ${entry.environment ? `<div><i class="fas fa-home"></i> ${entry.environment}</div>` : ''}
                            ${setupDurationText ? `<div><i class="fas fa-clock"></i> ${setupDurationText}</div>` : ''}
                        </div>
                    `;
                }

                // Gerar ações
                let actionsHtml = "";
                if (entry.action) {
                    actionsHtml = `
                        <div class="actions-container">
                            ${entry.action.split(", ").map(action => {
                                let iconClass = "";
                                if (action === "Poda FIM") iconClass = "fas fa-cut";
                                else if (action === "Poda Top") iconClass = "fas fa-cut";
                                else if (action === "LST") iconClass = "fas fa-vine";
                                else if (action === "SCROG") iconClass = "fas fa-border-all";
                                else if (action === "Transplante") iconClass = "fas fa-seedling";
                                else if (action === "Defoliação") iconClass = "fas fa-leaf";
                                else if (action === "Controle de Praga") iconClass = "fas fa-bug";
                                else if (action === "Colheita") iconClass = "fas fa-cannabis";
                                else iconClass = "fas fa-tasks";
                                
                                return `<div class="action-chip" data-action="${action}">
                                    <i class="${iconClass}"></i> ${action}
                                </div>`;
                            }).join("")}
                        </div>
                    `;
                }
                
                // Gerar detalhes
                let detailsHtml = "";
                if (entry.ph || entry.ec || entry.temperature || entry.humidity || entry.watering || entry.wetWeight || entry.dryWeight) {
                    detailsHtml = `
                        <div class="event-details">
                            ${entry.ph ? `
                            <div class="detail-item">
                                <div class="detail-label">pH</div>
                                <div class="detail-value">${entry.ph}</div>
                            </div>
                            ` : ""}
                            
                            ${entry.ec ? `
                            <div class="detail-item">
                                <div class="detail-label">EC (mS/cm)</div>
                                <div class="detail-value">${entry.ec}</div>
                            </div>
                            ` : ""}
                            
                            ${entry.temperature ? `
                            <div class="detail-item">
                                <div class="detail-label">Temperatura</div>
                                <div class="detail-value">${entry.temperature}°C</div>
                            </div>
                            ` : ""}
                            
                            ${entry.humidity ? `
                            <div class="detail-item">
                                <div class="detail-label">Umidade</div>
                                <div class="detail-value">${entry.humidity}%</div>
                            </div>
                            ` : ""}
                            
                            ${entry.watering ? `
                            <div class="detail-item">
                                <div class="detail-label">Tipo de Rega</div>
                                <div class="detail-value">${entry.watering}</div>
                            </div>
                            ` : ""}

                            ${entry.wetWeight ? `
                            <div class="detail-item">
                                <div class="detail-label">Peso Úmido</div>
                                <div class="detail-value">${entry.wetWeight}g</div>
                            </div>
                            ` : ""}

                            ${entry.dryWeight ? `
                            <div class="detail-item">
                                <div class="detail-label">Peso Seco</div>
                                <div class="detail-value">${entry.dryWeight}g</div>
                            </div>
                            ` : ""}
                        </div>
                    `;
                }
                
                // Gerar imagens
                let imagesHtml = "";
                let imageUrl = "";
                
                if (entry.imageFileName && permissionGranted) {
                    // Carregar do sistema de arquivos
                    imageUrl = await loadImageFromFileSystem(entry.imageFileName);
                }
                
                if (!imageUrl && entry.imageData) {
                    // Fallback para base64
                    imageUrl = entry.imageData;
                }
                
                if (imageUrl) {
                    imagesHtml = `
                        <div class="event-images">
                            <img src="${imageUrl}" 
                                 class="event-image" 
                                 alt="Imagem do evento">
                        </div>
                    `;
                }
                
                const eventElement = document.createElement("div");
                eventElement.className = "timeline-event";
                eventElement.innerHTML = `
                    <div class="event-card ${isCurrent ? "current" : ""}">
                        <div class="event-actions">
                            <button class="event-menu-btn">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="event-menu">
                                <button class="edit-event-btn" data-id="${entry.id}">Editar</button>
                                <button class="delete-event-btn" data-id="${entry.id}">Excluir</button>
                            </div>
                        </div>
                        <div class="event-header">
                            <div class="event-icon ${entry.iconClass || "action-icon"}">
                                <i class="${entry.icon || "fas fa-clipboard-list"}"></i>
                            </div>
                            <div class="event-date">${formattedDate}</div>
                        </div>
                        
                        <div class="event-title">${entry.title || "Registro"}</div>
                        <div class="event-phase ${phaseClass}">${phaseName}</div>
                        
                        ${setupInfoHtml}

                        ${actionsHtml}
                        
                        <div class="event-description">${entry.description || (entry.notes || '').replace(/\n/g, '<br>') || "Sem descrição"}</div>
                        
                        ${detailsHtml}
                        
                        ${imagesHtml}
                        
                        <div style="margin-top: 15px; font-size: 0.95rem; color: #b0b0b0;">
                            <i class="fas fa-calendar-day"></i> Dia ${daysSinceGermination} de crescimento
                        </div>
                    </div>
                `;
                
                timelineContainer.appendChild(eventElement);
                
                // Configurar clique nas imagens
                if (imagesHtml) {
                    const img = eventElement.querySelector(".event-image");
                    if (img) {
                        img.addEventListener("click", () => {
                            document.getElementById("modalImage").src = img.src;
                            document.getElementById("imageModal").style.display = "flex";
                        });
                    }
                }
                
                // Configurar botões de ação
                eventElement.querySelector('.edit-event-btn').addEventListener('click', function() {
                    editEvent(this.dataset.id);
                });
                
                eventElement.querySelector('.delete-event-btn').addEventListener('click', function() {
                    deleteEvent(this.dataset.id);
                });
            }
            
            // Adicionar evento atual (hoje)
         //  const todayEvent = document.createElement("div");
            todayEvent.className = "timeline-event";
            todayEvent.innerHTML = `
                <div class="event-card current">
                    <div class="event-header">
                        <div class="event-icon action-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="event-date">Hoje</div>
                    </div>
                    
                    <div class="event-title">Estado Atual</div>
                    <div class="event-description">Esta é a situação atual da planta</div>
                    
                    <div style="margin-top: 15px; font-size: 0.95rem; color: #b0b0b0;">
                        <i class="fas fa-calendar-day"></i> Dia ${ageInDays} de crescimento
                    </div>
                </div>
            `;
            timelineContainer.appendChild(todayEvent);
        }

        // Carregar galeria de fotos
        async function loadPhotoGallery(plantId) {
            const photoGrid = document.getElementById('photoGrid');
            photoGrid.innerHTML = '';
            
            const plant = plants.find(p => p.id === plantId);
            if (!plant) return;
            
            // Obter entradas com imagens
            const entriesWithPhotos = journalEntries.filter(entry => 
                entry.plantId === plantId && 
                (entry.imageData || entry.imageFileName)
            );
            
            if (entriesWithPhotos.length === 0) {
                document.getElementById('photoGallery').style.display = 'none';
                return;
            }
            
            document.getElementById('photoGallery').style.display = 'block';
            
            // Ordenar do mais antigo para o mais recente (ordem crescente)
            entriesWithPhotos.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Atualizar lista de fotos para a galeria ampliada
            currentGalleryPhotos = [];
            
            for (const entry of entriesWithPhotos) {
                let imageUrl = '';
                
                // Tentar carregar do sistema de arquivos primeiro
                if (entry.imageFileName && permissionGranted) {
                    imageUrl = await loadImageFromFileSystem(entry.imageFileName);
                }
                
                // Fallback para base64
                if (!imageUrl && entry.imageData) {
                    imageUrl = entry.imageData;
                }
                
                if (imageUrl) {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = `Foto de ${entry.date}`;
                    photoItem.appendChild(img);
                    photoGrid.appendChild(photoItem);
                    
                    // Adicionar à lista de fotos para a galeria ampliada
                    currentGalleryPhotos.push({
                        src: imageUrl,
                        date: entry.date,
                        title: entry.title || 'Registro'
                    });
                    
                    // Configurar clique para abrir a galeria ampliada
                    photoItem.addEventListener('click', () => {
                        const index = currentGalleryPhotos.findIndex(p => p.src === imageUrl);
                        if (index !== -1) {
                            openGalleryModal(index);
                        }
                    });
                }
            }
        }

        // Abrir galeria ampliada
        function openGalleryModal(index) {
            history.pushState({ modal: 'galleryModal' }, 'Galeria', '#gallery');
            if (currentGalleryPhotos.length === 0) return;
            
            currentGalleryIndex = index;
            updateGalleryModal();
            document.getElementById('galleryModal').style.display = 'flex';
        }

        // Fechar galeria ampliada
        function closeGalleryModal() {
            if (history.state && history.state.modal === 'galleryModal') {
                history.back();
            }
            document.getElementById('galleryModal').style.display = 'none';
        }

        // Atualizar galeria ampliada
        function updateGalleryModal() {
            if (currentGalleryPhotos.length === 0) return;
            
            const photo = currentGalleryPhotos[currentGalleryIndex];
            const galleryMainImage = document.getElementById('galleryMainImage');
            const galleryPhotoInfo = document.getElementById('galleryPhotoInfo');
            const galleryThumbnails = document.getElementById('galleryThumbnails');
            
            galleryMainImage.src = photo.src;
            galleryPhotoInfo.textContent = `${photo.title} - ${parseLocalDate(photo.date).toLocaleDateString('pt-BR')}`;
            
            // Atualizar miniaturas
            galleryThumbnails.innerHTML = '';
            
            currentGalleryPhotos.forEach((p, i) => {
                const thumb = document.createElement('div');
                thumb.className = `gallery-thumbnail ${i === currentGalleryIndex ? 'active' : ''}`;
                thumb.innerHTML = `<img src="${p.src}" alt="Miniatura">`;
                
                thumb.addEventListener('click', () => {
                    currentGalleryIndex = i;
                    updateGalleryModal();
                });
                
                galleryThumbnails.appendChild(thumb);
            });
        }

        // Navegar entre fotos na galeria ampliada
        function navigateGallery(direction) {
            currentGalleryIndex += direction;
            
            // Verificar limites
            if (currentGalleryIndex < 0) {
                currentGalleryIndex = currentGalleryPhotos.length - 1;
            } else if (currentGalleryIndex >= currentGalleryPhotos.length) {
                currentGalleryIndex = 0;
            }
            
            updateGalleryModal();
        }

        // Determinar fase da planta com períodos de transição
        function getPlantPhase(plant, entryDate) {
            if (!plant.germinationDate) return "";

            const germDate = parseLocalDate(plant.germinationDate);
            const refDate = entryDate ? parseLocalDate(entryDate) : new Date();
            refDate.setHours(0, 0, 0, 0); // Normaliza para meia-noite local para consistência

            // 1. Verifica se há mudanças de fase manuais e encontra a mais relevante
            if (plant.phaseChanges && plant.phaseChanges.length > 0) {
                const relevantChange = plant.phaseChanges
                    .filter(change => parseLocalDate(change.date) <= refDate)
                    .sort((a, b) => parseLocalDate(b.date) - parseLocalDate(a.date))[0];

                if (relevantChange) {
                    return relevantChange.phase;
                }
            }

            // 2. Se não houver mudança manual aplicável, usa a lógica baseada na idade
            const ageInDays = Math.floor((refDate - germDate) / (1000 * 60 * 60 * 24));

            if (plant.type === "auto") {
                // Automáticas têm fases mais rápidas e definidas
                if (ageInDays < 30) return "vegetative";
                if (ageInDays < 35) return "transition"; // Transição vegetativo-floração
                if (ageInDays < 50) return "flowering";
                if (ageInDays < 55) return "transition"; // Transição floração-frutificação
                if (ageInDays < 65) return "fruiting";
                return "harvest";
            } else {
                // Fotoperíodo têm fases mais longas e transições mais graduais
                if (ageInDays < 30) return "vegetative";
                if (ageInDays < 37) return "transition"; // Transição vegetativo-pré-floração
                if (ageInDays < 49) return "preflower";
                if (ageInDays < 84) return "flowering";
                if (ageInDays < 99) return "transition"; // Transição floração-frutificação
                if (ageInDays < 112) return "fruiting";
                return "harvest";
            }
        }

        // Obter nome da fase
        function getPhaseName(phase) {
            switch(phase) {
                case "vegetative": return "Fase Vegetativa";
                case "preflower": return "Pré-Floração";
                case "flowering": return "Floração";
                case "fruiting": return "Frutificação";
                case "harvest": return "Colheita";
                case "transition": return "Período de Transição";
                default: return "Germinação";
            }
        }

        // Obter classe CSS da fase
        function getPhaseClass(phase) {
            switch(phase) {
                case "vegetative": return "phase-vegetative";
                case "preflower": return "phase-preflower";
                case "flowering": return "phase-flowering";
                case "fruiting": return "phase-fruiting";
                default: return "phase-vegetative";
            }
        }

        // Exportar linha do tempo
        async function generatePdfWithOptions(e) {
            if (e) e.preventDefault(); // Prevenir submit do formulário

            if (!selectedPlant) {
                showStatusBar('Selecione uma planta primeiro.', 'error');
                return;
            }

            // Coletar opções do modal
            const options = {
                title: document.getElementById('pdfTitle').value.trim() || `Diário de Cultivo: ${selectedPlant.name}`,
                includeDetails: document.getElementById('pdfIncludeDetails').checked,
                includeImages: document.getElementById('pdfIncludeImages').checked,
                includeSetup: document.getElementById('pdfIncludeSetup').checked,
            };

            const btn = document.getElementById('exportTimelineBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

                const plant = selectedPlant;
                const plantEntries = journalEntries
                    .filter(entry => entry.plantId === plant.id)
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); // Do mais recente para o mais antigo

                // --- Cabeçalho do PDF ---
                doc.setFontSize(20);
                doc.text(options.title, 15, 20);
                doc.setFontSize(12);
                doc.text(`Tipo: ${plant.type === 'auto' ? 'Automática' : 'Fotoperíodo'}`, 15, 30);
                doc.text(`Germinação: ${new Date(plant.germinationDate).toLocaleDateString('pt-BR')}`, 15, 35);
                doc.line(15, 40, 195, 40); // Linha horizontal

                let yPosition = 50;
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;

                // --- Loop pelos registros ---
                for (const entry of plantEntries) {
                    const tempContainer = document.createElement('div');
                    tempContainer.style.position = 'absolute';
                    tempContainer.style.left = '-9999px';
                    tempContainer.style.width = '180mm';
                    tempContainer.style.padding = '10px';
                    tempContainer.style.background = 'white';
                    tempContainer.style.color = 'black';
                    tempContainer.style.fontFamily = 'sans-serif';
                    tempContainer.style.border = '1px solid #ccc';
                    tempContainer.style.borderRadius = '5px';

                    // --- Informações do Evento ---
                    const eventDate = parseLocalDate(entry.date);
                    const germDate = parseLocalDate(plant.germinationDate);
                    const daysSinceGermination = Math.floor((eventDate - germDate) / (1000 * 60 * 60 * 24)) + 1;
                    const phase = getPlantPhase(plant, entry.date);
                    const phaseName = getPhaseName(phase);

                    let entryHtml = `
                        <h3 style="font-size: 14px; margin-bottom: 5px;">${entry.title || 'Registro'} - ${parseLocalDate(entry.date).toLocaleDateString('pt-BR')}</h3>
                        <p style="font-size: 11px; color: #555; margin-bottom: 8px;">
                            <strong>Dia ${daysSinceGermination}</strong> | Fase: ${phaseName}
                        </p>
                        ${options.includeSetup ? `<p style="font-size: 11px; margin-bottom: 8px;"><strong>Setup:</strong> Iluminação: ${entry.lighting || 'N/A'}, Ambiente: ${entry.environment || 'N/A'}, Tempo de Luz: ${entry.lightDuration || 'N/A'}</p>` : ''}
                        ${entry.action ? `<p style="font-size: 12px; margin-bottom: 8px;"><strong>Ações:</strong> ${entry.action}</p>` : ''}
                        <p style="font-size: 12px; margin-bottom: 8px;">${(entry.notes || 'Sem observações.').replace(/\n/g, '<br>')}</p>
                    `;

                    // --- Tabela de Detalhes ---
                    if (options.includeDetails) {
                        const details = {
                            'pH': entry.ph,
                            'EC (mS/cm)': entry.ec,
                            'Temp.': entry.temperature ? `${entry.temperature}°C` : null,
                            'Umid.': entry.humidity ? `${entry.humidity}%` : null,
                            'Rega': entry.watering,
                            'Peso Úmido': entry.wetWeight ? `${entry.wetWeight}g` : null,
                            'Peso Seco': entry.dryWeight ? `${entry.dryWeight}g` : null,
                        };

                        const headers = Object.keys(details).filter(key => details[key] != null && details[key] !== '');
                        const values = headers.map(key => details[key]);

                        if (headers.length > 0) {
                            entryHtml += `<table style="width: 100%; font-size: 11px; border-collapse: collapse; margin-bottom: 8px;">
                                <tr style="background: #eee;">
                                    ${headers.map(h => `<th style="border: 1px solid #ddd; padding: 4px;">${h}</th>`).join('')}
                                </tr>
                                <tr>
                                    ${values.map(v => `<td style="border: 1px solid #ddd; padding: 4px; text-align: center;">${v}</td>`).join('')}
                                </tr>
                            </table>`;
                        }
                    }

                    // --- Imagem ---
                    if (options.includeImages) {
                        // Carrega a imagem de qualquer fonte (filesystem ou base64)
                        const imageUrl = await getImageDataUrl(entry);
                        if (imageUrl) {
                            entryHtml += `<img src="${imageUrl}" style="max-width: 100%; border-radius: 5px; margin-top: 5px;">`;
                        }
                    }

                    tempContainer.innerHTML = entryHtml;
                    document.body.appendChild(tempContainer);

                    const canvas = await html2canvas(tempContainer, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff' // Fundo branco para evitar transparências
                    });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const imgHeight = (canvas.height * 180) / canvas.width;

                    if (yPosition + imgHeight > pageHeight - margin) {
                        doc.addPage();
                        yPosition = margin;
                    }

                    doc.addImage(imgData, 'JPEG', margin, yPosition, 180, imgHeight);
                    yPosition += imgHeight + 5;

                    document.body.removeChild(tempContainer);
                }

                closePdfOptionsModal();
                // Em vez de salvar diretamente, gera um data URI para a pré-visualização
                const pdfDataUri = doc.output('datauristring');
                const fileName = `diario_${plant.name.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;

                openPdfPreviewModal(pdfDataUri, fileName);
                showStatusBar('Pré-visualização do PDF gerada com sucesso!', 'success');

            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showStatusBar('Ocorreu um erro ao gerar o PDF.', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-pdf"></i> Exportar PDF';
            }
        }

        // Abrir modal de novo evento
        function addNewEvent() {
            history.pushState({ modal: 'eventModal' }, 'Novo Registro', '#event');
            if (!selectedPlant) {
                alert("Selecione uma planta primeiro");
                return;
            }
            
            document.getElementById('eventModalTitle').textContent = "Adicionar Registro";
            document.getElementById('eventId').value = '';
            document.getElementById('deleteEventBtn').style.display = 'none';

            // Limpar campos
            document.getElementById('eventForm').reset();

            // Definir data atual como padrão APÓS o reset
            setTodayAsDefaultDate();

            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('harvestFields').style.display = 'none';

            // Resetar botões de ação
            document.querySelectorAll('.action-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Abrir modal
            document.getElementById('eventModal').style.display = 'flex';
        }

        // Abrir modal para editar evento
        function editEvent(eventId) {
            history.pushState({ modal: 'eventModal' }, 'Editar Registro', '#event');
            const event = journalEntries.find(e => e.id === eventId);
            if (!event) return;
            
            document.getElementById('eventModalTitle').textContent = "Editar Registro";
            document.getElementById('eventId').value = event.id;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('ph').value = event.ph || '';
            document.getElementById('ec').value = event.ec || '';
            document.getElementById('temperature').value = event.temperature || '';
            document.getElementById('humidity').value = event.humidity || '';
            document.getElementById('wateringType').value = event.watering || '';
            document.getElementById('notes').value = event.notes || '';
            document.getElementById('wetWeight').value = event.wetWeight || '';
            document.getElementById('dryWeight').value = event.dryWeight || '';
            
            // Resetar botões de ação
            document.querySelectorAll('.action-button').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Selecionar ações existentes
            if (event.action) {
                event.action.split(", ").forEach(action => {
                    const actionButton = [...document.querySelectorAll('.action-button')]
                        .find(btn => btn.dataset.action === action);
                    if (actionButton) {
                        actionButton.classList.add('selected');
                    }
                });
            }
            
            // Mostrar/ocultar campos de colheita
            const harvestFields = document.getElementById('harvestFields');
            const harvestActionSelected = event.action && event.action.includes('Colheita');
            if (harvestFields) {
                harvestFields.style.display = harvestActionSelected ? 'block' : 'none';
            }

            // Mostrar preview de imagem se existir
            if (event.imageData) {
                document.getElementById('imagePreview').innerHTML = `
                    <img src="${event.imageData}" alt="Preview da imagem" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                `;
            }
            
            document.getElementById('deleteEventBtn').style.display = 'inline-block';
            document.getElementById('deleteEventBtn').dataset.id = eventId;
            document.getElementById('eventModal').style.display = 'flex';
        }

        // Deletar evento
        function deleteEvent(eventId) {
            if (!confirm('Tem certeza que deseja excluir este registro?')) {
                return;
            }
            
            const eventIndex = journalEntries.findIndex(e => e.id === eventId);
            if (eventIndex !== -1) {
                journalEntries.splice(eventIndex, 1);
                if (selectedPlant) {
                    loadTimeline(selectedPlant.id);
                    renderWateringCalendar(selectedPlant);
                }
                closeEventModal();
                saveData();
                showStatusBar('Registro excluído com sucesso!', 'success');
            }
        }

        // Preview de imagem antes de salvar
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                preview.innerHTML = `
                    <img src="${e.target.result}" alt="Preview da imagem" style="max-width: 100%; border-radius: 8px; margin-top: 10px;">
                `;
            };
            reader.readAsDataURL(file);
        }
        
        // Validar data do evento
        function validateEventDate(dateStr) {
            if (!selectedPlant) return false;
            
            const eventDate = parseLocalDate(dateStr);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Verificar se a data é no futuro
            if (eventDate > today) {
                showValidationError('eventDate', 'Não é possível registrar eventos no futuro');
                return false;
            }
            
            // Verificar se a data é antes da germinação
            const germDate = new Date(selectedPlant.germinationDate);
            if (eventDate < germDate) {
                showValidationError('eventDate', 'A data não pode ser anterior à germinação');
                return false;
            }
            
            return true;
        }
        
        // Salvar evento
        async function saveEvent(e) {
            e.preventDefault();

            if (!selectedPlant) {
                alert("Selecione uma planta primeiro");
                return;
            }

            // Resetar erros de validação
            resetValidationErrors();

            // Validar data
            const eventDate = document.getElementById('eventDate').value;
            if (!validateEventDate(eventDate)) {
                return;
            }

            // Obter valores do formulário
            const eventId = document.getElementById('eventId').value;
            const ph = document.getElementById('ph').value;
            const ec = document.getElementById('ec').value;
            const temperature = document.getElementById('temperature').value;
            const humidity = document.getElementById('humidity').value;
            const wateringType = document.getElementById('wateringType').value;
            const notes = document.getElementById('notes').value;
            const wetWeight = document.getElementById('wetWeight').value;
            const dryWeight = document.getElementById('dryWeight').value;

            // Obter o setup atual para snapshot no evento
            const currentSetup = setups.find(s => s.id === selectedPlant.setupId);
            const currentLighting = currentSetup ? currentSetup.lighting : 'Não definido';
            const currentEnvironment = currentSetup ? currentSetup.environment : 'Não definido';
                const currentLightDuration = currentSetup ? (currentSetup.lightDuration || '') : '';

            // Obter ações selecionadas
            const actions = Array.from(document.querySelectorAll('.action-button.selected'))
                         .map(btn => btn.dataset.action);

            // Processar imagem
            let imageFileName = null;
            let imageData = null;
            const fileInput = document.getElementById('eventImage');
            if (fileInput.files.length > 0) {
                const imageFile = fileInput.files[0];

                // Tenta salvar no sistema de arquivos primeiro
                if (permissionGranted && directoryHandle) {
                    imageFileName = await saveImageToFileSystem(imageFile, selectedPlant, eventDate);
                }

                // Se não foi possível salvar no sistema de arquivos (sem permissão ou erro), usa o fallback para base64.
                // Isso evita encher o localStorage desnecessariamente.
                if (!imageFileName) {
                    try {
                        imageData = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                            reader.readAsDataURL(imageFile);
                        });
                    } catch (error) {
                        console.error("Erro ao ler o arquivo de imagem:", error);
                        showStatusBar('Falha ao processar a imagem.', 'error');
                        return;
                    }
                }
            }

            if (eventId) {
                // Editar evento existente
                const eventIndex = journalEntries.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    const updatedEvent = {
                        ...journalEntries[eventIndex],
                        date: eventDate,
                        ph: ph || undefined,
                        ec: ec || undefined,
                        temperature: temperature || undefined,
                        humidity: humidity || undefined,
                        watering: wateringType || undefined,
                        action: actions.join(', ') || undefined,
                        notes: notes || undefined,
                        wetWeight: wetWeight || undefined,
                        dryWeight: dryWeight || undefined
                    };

                    // Se uma nova imagem foi adicionada, ela substitui a antiga.
                    if (fileInput.files.length > 0) {
                        updatedEvent.imageFileName = imageFileName;
                        updatedEvent.imageData = imageData;
                    }

                    journalEntries[eventIndex] = updatedEvent;
                }
            } else {
                // Criar novo evento
                const newId = String(Date.now());
                const newEvent = {
                    id: newId,
                    plantId: selectedPlant.id,
                    date: eventDate,
                    ph: ph || undefined,
                    ec: ec || undefined,
                    temperature: temperature || undefined,
                    humidity: humidity || undefined,
                    watering: wateringType || undefined,
                    action: actions.join(', ') || undefined,
                    notes: notes || undefined,
                    imageFileName: imageFileName, // Será null se não salvou no FS
                    imageData: imageData,         // Será null se salvou no FS
                    wetWeight: wetWeight || undefined,
                    dryWeight: dryWeight || undefined,
                    lighting: currentLighting,
                    environment: currentEnvironment,
                        lightDuration: currentLightDuration,
                    createdAt: new Date().toISOString()
                };
                journalEntries.push(newEvent);
            }

            if (selectedPlant) {
                loadTimeline(selectedPlant.id);
                renderWateringCalendar(selectedPlant);
            }
            closeEventModal();
            saveData();
            showStatusBar(`Registro ${eventId ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
        }

        // Fechar modal de evento
        function closeEventModal() {
            if (history.state && history.state.modal === 'eventModal') {
                history.back();
            }
            document.getElementById('eventModal').style.display = 'none';
        }

        // Fechar modal de imagem
        function closeImageModal() {
            if (history.state && history.state.modal === 'imageModal') {
                history.back();
            }
            document.getElementById("imageModal").style.display = "none";
        }
        
        // --- LÓGICA DE ARRASTAR E SOLTAR (SORTABLEJS) ---
        function initSortable() {
            const plantList = document.getElementById('plantList');
            if (plantList) {
                Sortable.create(plantList, {
                    handle: '.plant-drag-handle', // Define o elemento que inicia o arrasto
                    animation: 150, // Animação suave ao mover
                    ghostClass: 'sortable-ghost', // Estilo do placeholder
                    chosenClass: 'sortable-chosen', // Estilo do item sendo arrastado
                    forceFallback: true, // Essencial para uma melhor experiência em dispositivos móveis
                    scroll: true, // Habilita o auto-scroll
                    scrollSensitivity: 70, // Distância em pixels da borda para iniciar o scroll
                    scrollSpeed: 15, // Velocidade do scroll
                    onEnd: (evt) => {
                        // evt.oldIndex e evt.newIndex são os índices antes e depois da movimentação
                        
                        // Reordena o array 'plants' para refletir a mudança no DOM
                        const movedPlant = plants.splice(evt.oldIndex, 1)[0];
                        plants.splice(evt.newIndex, 0, movedPlant);
                        
                        // Salva a nova ordem no localStorage
                        saveData();
                        
                        // Fornece feedback ao usuário
                        showStatusBar('Ordem das plantas atualizada!', 'success');
                    }
                });
            }
        }

        // Salvar dados no localStorage
        function saveData() {
            try {
                localStorage.setItem('setups', JSON.stringify(setups));
                localStorage.setItem('plants', JSON.stringify(plants));
                localStorage.setItem('journalEntries', JSON.stringify(journalEntries));
                localStorage.setItem('savedDirectory', savedDirectory);
                localStorage.setItem('npkSettings', JSON.stringify(npkSettings));
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
                showStatusBar('Erro ao salvar: o armazenamento pode estar cheio. Tente remover imagens antigas.', 'error');
            }
        }

        // Carregar dados
        async function loadData() {
            const savedPlants = localStorage.getItem('plants');
            const savedSetups = localStorage.getItem('setups');
            const savedEntries = localStorage.getItem('journalEntries');
            const savedDir = localStorage.getItem('savedDirectory');
            const savedNPK = localStorage.getItem('npkSettings');
            
            if (savedPlants) {
                const loadedPlants = JSON.parse(savedPlants);
                // Script de migração para garantir compatibilidade com versões antigas de dados.
                // Garante que todas as plantas tenham os campos 'lighting' e 'environment'.
                plants = loadedPlants.map(plant => ({
                    ...plant,
                    lighting: plant.lighting || 'Não definido',
                    environment: plant.environment || 'Não definido'
                }));
            }
            if (savedSetups) setups = JSON.parse(savedSetups);
            if (savedEntries) journalEntries = JSON.parse(savedEntries);
            if (savedDir) savedDirectory = savedDir;
            if (savedNPK) npkSettings = JSON.parse(savedNPK);
            
            // Carregar configurações de NPK do IndexedDB
            const savedNPKFromDB = await loadNPKSettingsFromDB();
            if (savedNPKFromDB) {
                npkSettings = savedNPKFromDB;
            } else if (!savedNPK) {
                // Configurações padrão
                npkSettings = {
                    vegetative: { n: 10, p: 5, k: 5 },
                    flowering: { n: 5, p: 10, k: 15 },
                    fruiting: { n: 3, p: 12, k: 18 }
                };
                await saveNPKSettingsToDB(npkSettings);
            }
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', async function() {
            // Carregar dados salvos

            // Adiciona um estado inicial ao histórico para "capturar" o botão voltar.
            // Isso garante que haja sempre um estado para onde "voltar" dentro do app.
            history.pushState({ app_root: true }, '');

            await loadData();
            
            // Inicializar sistema de arquivos
            permissionGranted = await initFileSystem();
            
            // Se não houver permissão persistida, solicitar ao usuário
            if (!permissionGranted) {
                document.getElementById('permissionRequest').style.display = 'flex';
            }
            // Dados de exemplo para demonstração (apenas se não houver dados salvos)
            if (plants.length === 0 && journalEntries.length === 0) {
                plants = [
                    {
                        id: "1",
                        name: "Purple Haze #1",
                        type: "auto",
                        genetics: "Sativa",
                        lighting: "LED 150W",
                        environment: "Grow 60x60",
                        germinationDate: "2023-08-15",
                        createdAt: "2023-08-10T12:00:00Z"
                    },
                    {
                        id: "2",
                        name: "Northern Lights",
                        type: "photo",
                        genetics: "Índica",
                        lighting: "HPS 400W",
                        environment: "Outdoor",
                        germinationDate: "2023-09-01",
                        createdAt: "2023-08-25T12:00:00Z"
                    }
                ];
                
                journalEntries = [
                    {
                        id: "101",
                        plantId: "1",
                        date: "2023-08-22",
                        ph: "6.2",
                        ec: "1.2",
                        temperature: "24.5",
                        humidity: "65",
                        watering: "Fertilizante mineral",
                        action: "Poda FIM, Transplante",
                        notes: "Planta apresentando bom desenvolvimento com crescimento vigoroso",
                        imageData: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==",
                        createdAt: "2023-08-22T14:30:00Z"
                    },
                    {
                        id: "102",
                        plantId: "1",
                        date: "2023-09-05",
                        ph: "6.0",
                        ec: "1.8",
                        temperature: "25.0",
                        humidity: "60",
                        watering: "Fertilizante organo-mineral",
                        action: "LST, Defoliação",
                        notes: "Iniciando fase de floração com formação de pré-flores",
                        imageData: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==",
                        createdAt: "2023-09-05T10:15:00Z"
                    }
                ];
                
                // Salvar dados iniciais
                saveData();
            }
            
            renderPlantList();
            renderEnvironmentsSummary();
            setupEventListeners();
            initSortable(); // Habilita o arrastar e soltar na lista de plantas
            updateCarouselNav();
            setTodayAsDefaultDate();
            updateFolderIndicator();
            
            // REGISTRO DO SERVICE WORKER PARA PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar o Service Worker:', error);
                    });
            }
        });

        // --- LÓGICA DE GERENCIAMENTO DE SETUPS ---

        function renderSetupsList() {
            const listContainer = document.getElementById('setupsList');
            listContainer.innerHTML = '';

            if (setups.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #b0b0b0;">Nenhum setup cadastrado.</p>';
                return;
            }

            setups.forEach(setup => {
                const item = document.createElement('div');
                item.className = 'setup-list-item';
                item.innerHTML = `
                    <div class="setup-item-details">
                        <h4>${setup.name}</h4>
                        <p><i class="fas fa-lightbulb"></i> ${setup.lighting} | <i class="fas fa-home"></i> ${setup.environment} ${setup.lightDuration ? `| <i class="fas fa-hourglass-half"></i> ${setup.lightDuration}` : ''}</p>
                    </div>
                    <div class="setup-item-actions">
                        <button class="edit-setup-btn" data-id="${setup.id}" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="delete-setup-btn" data-id="${setup.id}" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                listContainer.appendChild(item);
            });
        }

        function handleSetupFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('setupId').value;
            const name = document.getElementById('setupName').value.trim();
            const lighting = document.getElementById('setupLighting').value.trim();
            const environment = document.getElementById('setupEnvironment').value.trim();
            const lightDuration = document.getElementById('setupLightDuration').value.trim();

            if (!name || !lighting || !environment) {
                showStatusBar('Todos os campos do setup são obrigatórios.', 'error');
                return;
            }

            if (id) {
                // Editar setup existente
                const setupIndex = setups.findIndex(s => s.id === id);
                if (setupIndex !== -1) {
                    setups[setupIndex] = { ...setups[setupIndex], name, lighting, environment, lightDuration };
                    showStatusBar('Setup atualizado com sucesso!', 'success');
                }
            } else {
                // Adicionar novo setup
                const newSetup = { id: String(Date.now()), name, lighting, environment, lightDuration };
                setups.push(newSetup);
                showStatusBar('Setup adicionado com sucesso!', 'success');
            }

            saveData();
            renderSetupsList();
            renderEnvironmentsSummary();
            renderPlantList(); // Atualiza os cards das plantas caso um setup tenha sido editado
            document.getElementById('setupForm').reset();
            document.getElementById('setupId').value = '';
        }

        function editSetup(id) {
            const setup = setups.find(s => s.id === id);
            if (setup) {
                document.getElementById('setupId').value = setup.id;
                document.getElementById('setupName').value = setup.name;
                document.getElementById('setupLighting').value = setup.lighting;
                document.getElementById('setupEnvironment').value = setup.environment;
                document.getElementById('setupLightDuration').value = setup.lightDuration || '';
                document.getElementById('setupName').focus(); // Foca no campo de nome para facilitar a edição
            }
        }

        function deleteSetup(id) {
            // Verificar se o setup está em uso
            const isSetupInUse = plants.some(plant => plant.setupId === id);
            if (isSetupInUse) {
                alert('Este setup não pode ser excluído porque está sendo usado por uma ou mais plantas.');
                return;
            }

            if (confirm('Tem certeza que deseja excluir este setup?')) {
                setups = setups.filter(s => s.id !== id);
                saveData();
                renderEnvironmentsSummary();
                renderSetupsList();
                showStatusBar('Setup excluído com sucesso.', 'success');
            }
        }

        // --- FIM DA LÓGICA DE SETUPS ---
    </script>
</body>
</html>
